{% extends "base_dashboard.html" %}

{% block title %}Analyse {{ analysis.id }} - NeuroScan{% endblock %}
{% block page_title %}Rapport d'Analyse IA{% endblock %}
{% block page_subtitle %}Détails complets et interprétation clinique{% endblock %}
{% block page_description %}Vue dédiée pour l'analyse n° {{ analysis.id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="../static/css/res_analyse.css">
{% endblock %}

{% block content %}
<!-- Données JSON pour JavaScript -->
<script type="application/json" id="analysis-json">
{
  "id": {{ analysis.id }},
  "predicted_label": "{{ analysis.predicted_label }}",
  "confidence": {{ analysis.confidence }},
  "patient_name": "{{ analysis.patient_name }}",
  "patient_id": "{{ analysis.patient_id or '' }}",
  "exam_date": "{{ analysis.exam_date or '' }}",
  "timestamp": "{{ analysis.timestamp }}",
  "filename": "{{ analysis.filename }}",
  "probabilities": {{ analysis.probabilities|tojson if analysis.probabilities else '{}' }}
}
</script>

<!-- En-tête rapport amélioré -->
<div class="analysis-header p-6 md:p-8 mb-6 text-white relative z-10">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
    <div class="flex items-start md:items-center gap-4">
      <div class="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur-sm text-white flex items-center justify-center shadow-lg flex-shrink-0">
        <i class="fas fa-file-medical text-xl"></i>
      </div>
      <div class="min-w-0">
        <h1 class="text-2xl md:text-3xl font-bold mb-2">Rapport d'Analyse IA • #{{ analysis.id }}</h1>
        <p class="text-white/80 text-sm md:text-base">Généré automatiquement • {{ analysis.timestamp }}</p>
      </div>
    </div>
    
    <div class="flex flex-wrap items-center gap-3">
      {% if analysis.patient_id %}
      <a href="/patient/{{ analysis.patient_id }}" class="action-btn secondary">
        <i class="fas fa-user"></i>
        <span class="hidden sm:inline">Patient</span>
      </a>
      {% endif %}
      <button id="detailShareBtn" class="action-btn success">
        <i class="fas fa-share"></i>
        <span class="hidden sm:inline">Partager</span>
      </button>
      <button id="detailPdfBtn" class="action-btn primary">
        <i class="fas fa-file-download"></i>
        <span class="hidden sm:inline">PDF</span>
      </button>
    </div>
  </div>
  
  <!-- Informations patient -->
  <div class="mt-6 flex flex-wrap gap-3">
    <div class="info-chip">
      <i class="fas fa-user text-blue-500"></i>
      <span>{{ analysis.patient_name }}</span>
    </div>
    <div class="info-chip">
      <i class="fas fa-hashtag text-purple-500"></i>
      <span>{{ analysis.patient_id or '—' }}</span>
    </div>
    <div class="info-chip">
      <i class="fas fa-calendar-day text-green-500"></i>
      <span>{{ analysis.exam_date or '—' }}</span>
    </div>
  </div>
</div>

<!-- Contenu principal -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
  <!-- Section Image et Métadonnées -->
  <div class="lg:col-span-5 space-y-6">
    <!-- Image IRM -->
    <div class="analysis-card p-0 overflow-hidden fade-in">
      <div class="image-container relative">
        <!-- Actions sur l'image -->
        <div class="image-actions">
          <button class="image-action-btn" onclick="toggleFullscreen()" title="Plein écran">
            <i class="fas fa-expand text-sm"></i>
          </button>
          <button class="image-action-btn" onclick="downloadImage()" title="Télécharger">
            <i class="fas fa-download text-sm"></i>
          </button>
          <button class="image-action-btn" onclick="toggleImageInfo()" title="Informations">
            <i class="fas fa-info text-sm"></i>
          </button>
        </div>

        <!-- Indicateur de zoom -->
        <div class="zoom-indicator">
          <i class="fas fa-search-plus mr-1"></i>
          Cliquer pour agrandir
        </div>

        <!-- Image principale -->
        <img id="analysisImage" 
             src="{{ analysis.image_url }}" 
             alt="Image IRM - Analyse {{ analysis.id }}" 
             class="w-full h-[480px] lg:h-[520px] object-contain bg-gradient-to-br from-gray-50 to-gray-100 cursor-pointer"
             onclick="openImageModal()"
             onload="hideImageLoading()"
             onerror="showImageError()"/>

        <!-- Animation de chargement -->
        <div id="imageLoading" class="image-loading">
          <div class="loading-spinner"></div>
        </div>

        <!-- Overlay avec informations -->
        <div class="image-overlay" id="imageOverlay">
          <div class="text-sm font-medium mb-1">{{ analysis.patient_name or 'Patient' }}</div>
          <div class="text-xs opacity-75">
            Analyse #{{ analysis.id }} • {{ analysis.exam_date or 'Date inconnue' }}
          </div>
          <div class="text-xs opacity-75 mt-1">
            Résolution: <span id="imageResolution">Chargement...</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Métadonnées techniques -->
    <div class="analysis-card p-6 fade-in">
      <div class="section-title">
        <i class="fas fa-info-circle bg-blue-100 text-blue-600"></i>
        Informations techniques
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="space-y-1">
          <div class="text-sm font-medium text-gray-500">Horodatage</div>
          <div class="font-semibold text-gray-900">{{ analysis.timestamp }}</div>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-medium text-gray-500">Durée d'analyse</div>
          <div class="font-semibold text-gray-900 flex items-center gap-2">
            <i class="fas fa-clock text-green-500 text-sm"></i>
            {{ '%.2f'|format(analysis.processing_time or 0) }}s
          </div>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-medium text-gray-500">Analyse précédente</div>
          <div class="font-semibold text-gray-900">{{ analysis.previous_analysis_id or '—' }}</div>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-medium text-gray-500">Fichier source</div>
          <div class="font-semibold text-gray-900 truncate" title="{{ analysis.filename }}">
            <i class="fas fa-file-image text-purple-500 mr-2"></i>{{ analysis.filename }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Résultats -->
  <div class="lg:col-span-7 space-y-6">
    <!-- Résultat principal -->
    <div class="analysis-card p-6 fade-in">
      <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-6">
        <div>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">{{ analysis.predicted_label }}</h2>
          <p class="text-gray-600">Diagnostic principal identifié par l'IA</p>
        </div>
        <div class="result-badge {{ 'bg-emerald-500 text-white' if analysis.predicted_label=='Normal' else ('bg-orange-500 text-white' if analysis.predicted_label=='Gliome' else ('bg-purple-500 text-white' if analysis.predicted_label=='Méningiome' else 'bg-blue-500 text-white')) }}">
          <i class="fas fa-{{ 'check-circle' if analysis.predicted_label=='Normal' else 'exclamation-triangle' }}"></i>
          {{ analysis.predicted_label }}
        </div>
      </div>
      
      <!-- Barre de confiance améliorée -->
      <div class="mb-6">
        <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
          <span class="font-medium">Niveau de confiance du diagnostic</span>
          <span class="font-bold text-2xl text-gray-900">{{ '%.1f'|format(analysis.confidence) }}%</span>
        </div>
        <div class="confidence-bar">
          <div id="confFill" class="confidence-fill" data-width="{{ '%.1f'|format(analysis.confidence) }}"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-500 mt-2">
          <span>Faible</span>
          <span>Élevé</span>
        </div>
      </div>
      
      <!-- Informations patient condensées -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-12">
          <i class="fas fa-user-circle text-blue-500 text-lg"></i>
          <div>
            <div class="text-gray-500">Patient</div>
            <div class="font-semibold">{{ analysis.patient_name }}</div>
          </div>
        </div>
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-12">
          <i class="fas fa-id-card text-purple-500 text-lg"></i>
          <div>
            <div class="text-gray-500">ID Patient</div>
            <div class="font-semibold">{{ analysis.patient_id or '—' }}</div>
          </div>
        </div>
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-12">
          <i class="fas fa-calendar text-green-500 text-lg"></i>
          <div>
            <div class="text-gray-500">Date d'examen</div>
            <div class="font-semibold">{{ analysis.exam_date or '—' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Répartition des scores améliorée -->
    <div class="analysis-card p-6 fade-in">
      <div class="section-title mb-6">
        <i class="fas fa-chart-pie bg-purple-100 text-purple-600"></i>
        Analyse détaillée des probabilités
      </div>
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <!-- Graphique donut -->
        <div class="flex items-center justify-center">
          <div class="relative w-64 h-64">
            <canvas id="probDonut" class="w-full h-full"></canvas>
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-center">
                <div class="text-2xl font-bold text-gray-900">{{ '%.1f'|format(analysis.confidence) }}%</div>
                <div class="text-sm text-gray-500">Confiance</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Barres de probabilités -->
        <div class="space-y-4">
          {% set colors = ['bg-blue-500','bg-purple-500','bg-green-500','bg-yellow-500','bg-red-500'] %}
          {% for name, value in analysis.probabilities.items() %}
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full prob-color-{{ loop.index0 }}"></div>
                <span class="font-medium text-gray-700">{{ name }}</span>
              </div>
              <span class="font-bold text-gray-900 text-lg">{{ '%.1f'|format(value) }}%</span>
            </div>
            <div class="prob-bar-container">
              <div class="prob-bar-fill prob-color-bg-{{ loop.index0 }}" data-width="{{ '%.1f'|format(value) }}"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Résumé clinique -->
    {% if analysis.description %}
    <div class="analysis-card p-6 fade-in">
      <div class="section-title">
        <i class="fas fa-stethoscope bg-green-100 text-green-600"></i>
        Résumé clinique
      </div>
      <div class="prose max-w-none">
        <p class="text-gray-700 leading-relaxed">{{ analysis.description }}</p>
      </div>
    </div>
    {% endif %}

    <!-- Recommandations -->
    <div class="analysis-card p-6 fade-in">
      <div class="section-title">
        <i class="fas fa-user-md bg-blue-100 text-blue-600"></i>
        Recommandations médicales
      </div>
      {% if analysis.recommendations and analysis.recommendations|length > 0 %}
      <div class="space-y-3">
        {% for r in analysis.recommendations %}
        <div class="flex items-start gap-4 p-4 bg-blue-50 rounded-16 border-l-4 border-blue-400">
          <i class="fas fa-lightbulb text-blue-500 mt-1 flex-shrink-0"></i>
          <span class="text-gray-700 leading-relaxed">{{ r }}</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-16 text-gray-500">
        <i class="fas fa-info-circle"></i>
        <span>Aucune recommandation spécifique enregistrée pour cette analyse.</span>
      </div>
      {% endif %}
    </div>

    <!-- Analyse IA Avancée (Gemini) -->
    <div class="analysis-card p-6 fade-in">
      <div class="section-title">
        <i class="fas fa-microscope bg-purple-100 text-purple-600"></i>
        Analyse IA Avancée
        <span class="text-sm font-normal text-gray-500 ml-2">(Powered by Gemini)</span>
      </div>
      
      <div id="advLoading" class="flex items-center justify-center p-8">
        <div class="flex items-center gap-3 text-gray-500">
          <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500"></div>
          <span>Analyse en cours avec l'IA avancée...</span>
        </div>
      </div>
      
      <div id="advContent" class="hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-emerald-100 rounded-12 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-stethoscope text-emerald-600"></i>
              </div>
              <div class="min-w-0">
                <h4 class="font-semibold text-gray-900 mb-2">Résumé clinique</h4>
                <div id="advSummary" class="text-gray-700 leading-relaxed">—</div>
              </div>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-blue-100 rounded-12 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-brain text-blue-600"></i>
              </div>
              <div class="min-w-0">
                <h4 class="font-semibold text-gray-900 mb-2">Explication du diagnostic</h4>
                <div id="advExplanation" class="text-gray-700 leading-relaxed">—</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="border-t border-gray-200 pt-6">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 bg-amber-100 rounded-12 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-notes-medical text-amber-600"></i>
            </div>
            <div class="min-w-0 w-full">
              <h4 class="font-semibold text-gray-900 mb-3">Suggestions de suivi</h4>
              <ul id="advSuggestions" class="space-y-2"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour l'affichage plein écran de l'image -->
<div id="imageModal" 
     class="fixed inset-0 bg-black bg-opacity-90 z-50 items-center justify-center opacity-0 transition-opacity duration-300" 
     style="display: none;" 
     onclick="closeImageModal()">
  <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
    <!-- Bouton de fermeture -->
    <button class="absolute top-4 right-4 z-10 w-12 h-12 rounded-full bg-black bg-opacity-50 text-white hover:bg-opacity-70 transition-all duration-200 flex items-center justify-center"
            onclick="closeImageModal()">
      <i class="fas fa-times text-lg"></i>
    </button>
    
    <!-- Image en plein écran -->
    <img id="modalImage" 
         class="max-w-full max-h-full object-contain transform scale-90 transition-transform duration-300 rounded-lg shadow-2xl"
         onclick="event.stopPropagation()">
    
    <!-- Informations de l'image -->
    <div class="absolute bottom-4 left-4 bg-black bg-opacity-70 text-white p-4 rounded-lg backdrop-blur-sm">
      <div class="font-semibold">{{ analysis.patient_name or 'Patient' }}</div>
      <div class="text-sm opacity-75 mt-1">Analyse #{{ analysis.id }} • {{ analysis.exam_date or 'Date inconnue' }}</div>
    </div>
    
    <!-- Actions rapides -->
    <div class="absolute bottom-4 right-4 flex gap-2">
      <button class="w-10 h-10 rounded-full bg-black bg-opacity-50 text-white hover:bg-opacity-70 transition-all duration-200 flex items-center justify-center"
              onclick="downloadImage()" title="Télécharger">
        <i class="fas fa-download"></i>
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="../static/js/res_analyse.js"></script>
{% endblock %}
