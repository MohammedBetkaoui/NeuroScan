{% extends "base_dashboard.html" %}

{% block title %}Mes Patients - NeuroScan{% endblock %}

{% block page_subtitle %}Suivi & Évolution{% endblock %}

{% block page_title %}Mes Patients{% endblock %}

{% block page_description %}Suivi longitudinal et gestion complète de vos patients{% endblock %}

{% block extra_css %}
<style>
    /* Styles spécifiques à la liste des patients */
    .patient-card {
    background: #ffffff; /* Fond blanc demandé */
        border: 1px solid rgba(229, 231, 235, 0.3);
        border-radius: var(--radius-xl);
        transition: var(--transition-normal);
        overflow: hidden;
    }

    .patient-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    /* Couleur de bordure neutre au survol (supprime le bleu) */
    border-color: rgba(229, 231, 235, 0.6);
    }

    .patient-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #0277bd;
        text-transform: uppercase;
    }

    .risk-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        /* Ajout d'une bordure pour rester visible sur fond blanc */
        border: 1px solid #e5e7eb;
    }

    /* Remplacement des couleurs (rouge/orange/vert) par blanc */
    .risk-low { background-color: #ffffff; }
    .risk-medium { background-color: #ffffff; }
    .risk-high { background-color: #ffffff; }

    .analysis-trend {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
    }

    /* Couleurs de tendance neutralisées */
    .trend-up { color: #6b7280; }
    .trend-down { color: #6b7280; }
    .trend-stable { color: #6b7280; }

    .search-filters {
        background: var(--surface-primary);
        border: 1px solid rgba(229, 231, 235, 0.3);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin-bottom: 24px;
    }

    .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #f3f4f6;
        border-radius: var(--radius-lg);
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: var(--transition-normal);
    }

    .filter-chip:hover {
        background: #e5e7eb;
    }

    .filter-chip.active {
        background: var(--primary-gradient);
        color: white;
    }

    .patient-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    @media (max-width: 768px) {
        .patient-grid {
            grid-template-columns: 1fr;
        }
    }
    .patient-card {
        position: relative;
    }

    /* Accents par niveau de risque supprimés (pas de barre colorée) */
    .patient-card.risk-high,
    .patient-card.risk-medium,
    .patient-card.risk-low { border-left: none; }

    /* Chips d'information */
    .info-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: #f3f4f6;
        color: #374151;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
    }
    .info-chip i { opacity: 0.7; }

    /* Contact */
    .contact-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .contact-item { display: inline-flex; align-items: center; gap: 8px; color: #4b5563; font-size: 13px; }
    .contact-item i { color: #6b7280; }

    /* Barre de confiance */
    .confidence-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; overflow: hidden; }
    .confidence-indicator { height: 100%; background: linear-gradient(90deg, #34d399, #10b981); border-radius: 9999px; }

    /* Alert chips (nouvelle palette) */
    .alert-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: .01em;
        border: 1px solid transparent;
    }
    /* Alertes neutralisées en blanc */
    .alert-sev-high, .alert-sev-medium, .alert-sev-low, .alert-sev-none {
        background: #ffffff; color: #374151; border-color: #e5e7eb;
    }
    .alert-chip i { opacity: .9; }

    /* Lampe d'alerte (indicateur lumineux) */
    .alert-lamp { display: inline-flex; align-items: center; gap: 10px; }
    .alert-lamp-dot { width: 12px; height: 12px; border-radius: 9999px; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset; position: relative; }
    .alert-lamp-dot::after {
        content: '';
        position: absolute; inset: -4px; border-radius: 9999px; opacity: .6; filter: blur(4px);
    }
    /* Lampes neutralisées (blanc) */
    .lamp-high, .lamp-medium, .lamp-low, .lamp-none { background: #ffffff; box-shadow: 0 0 0 2px rgba(229,231,235,.9) inset; }
    .lamp-high::after, .lamp-medium::after, .lamp-low::after, .lamp-none::after { background: transparent; }
    .lamp-pulse { animation: lampPulse 2s ease-in-out infinite; }
    @keyframes lampPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

    /* Désactivation finale des accents de risque pour garder les cartes blanches */
    .patient-card.risk-high,
    .patient-card.risk-medium,
    .patient-card.risk-low { border-left: none; }
    /* Neutralisation répétée pour assurer la priorité */
    .risk-low { background-color: #ffffff; }
    .risk-medium { background-color: #ffffff; }
    .risk-high { background-color: #ffffff; }
    .patient-avatar { background: var(--primary-gradient); color: #fff; }
    /* Barre de confiance en blanc (sur fond gris de la barre) */
    .confidence-indicator { background: #ffffff; }
    /* Chips d'alerte: rappeler la palette douce */
    /* Override final: toutes les alertes blanches */
    .alert-sev-high { background: #ffffff; color: #374151; border-color: #e5e7eb; }
    .alert-sev-medium { background: #ffffff; color: #374151; border-color: #e5e7eb; }
    .alert-sev-low { background: #ffffff; color: #374151; border-color: #e5e7eb; }
    /* Lampes colorées et glow doux */
    .lamp-high { background: #ef4444; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset, 0 0 10px rgba(239,68,68,.9); }
    .lamp-high::after { background: rgba(239,68,68,.8); }
    .lamp-medium { background: #f59e0b; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset, 0 0 10px rgba(245,158,11,.8); }
    .lamp-medium::after { background: rgba(245,158,11,.6); }
    .lamp-low { background: #3b82f6; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset, 0 0 10px rgba(59,130,246,.7); }
    .lamp-low::after { background: rgba(59,130,246,.5); }
    .lamp-pulse { animation: lampPulse 2s ease-in-out infinite; }
    /* Rétablir les badges diagnostic thématisés */
    .patient-card .badge.success,
    .patient-card .badge.warning,
    .patient-card .badge.danger,
    .patient-card .badge.info { background: #ffffff !important; color: #374151 !important; border: 1px solid #e5e7eb; }

    /* Icônes des cartes stats neutralisées */
    .stat-card .w-12.h-12 { background: #ffffff !important; }
    .stat-card .w-12.h-12 i { color: #6b7280 !important; }
</style>
{% endblock %}

{% block secondary_nav %}
<div class="dashboard-nav mb-8">
    <a href="{{ url_for('dashboard') }}" class="dashboard-nav-item">
        <i class="fas fa-home mr-2"></i>Accueil
    </a>
    <a href="{{ url_for('patients_list') }}" class="dashboard-nav-item active">
        <i class="fas fa-users mr-2"></i>Mes Patients
    </a>
    <a href="{{ url_for('manage_patients_page') }}" class="dashboard-nav-item">
        <i class="fas fa-user-plus mr-2"></i>Gestion
    </a>
    <a href="{{ url_for('medical_alerts_page') }}" class="dashboard-nav-item">
        <i class="fas fa-exclamation-triangle mr-2"></i>Alertes
    </a>
</div>
{% endblock %}

{% block page_actions %}
<div class="flex space-x-3">
    <button onclick="exportPatients()" class="btn-dashboard secondary">
        <i class="fas fa-download"></i>
        Exporter
    </button>
    <a href="{{ url_for('new_patient_page') }}" class="btn-dashboard success">
        <i class="fas fa-user-plus"></i>
        Nouveau Patient
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Statistiques rapides -->
<div class="stats-grid mb-8">
    <div class="stat-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stat-label">Total Patients</p>
                <p class="stat-value" id="totalPatients">-</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stat-label">Nouveaux ce mois</p>
                <p class="stat-value" id="newPatients">-</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-plus text-green-600 text-xl"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stat-label">Alertes Actives</p>
                <p class="stat-value" id="activeAlerts">-</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stat-label">Suivi Régulier</p>
                <p class="stat-value" id="regularFollow">-</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-heartbeat text-purple-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filtres et recherche -->
<div class="search-filters">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex-1">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <input type="text" 
                       id="searchInput"
                       class="form-input pl-10" 
                       placeholder="Rechercher un patient (nom, ID, diagnostic...)">
            </div>
        </div>
        
        <div class="flex flex-wrap gap-2">
            <div class="filter-chip active" data-filter="all">
                <i class="fas fa-users"></i>Tous
            </div>
            <div class="filter-chip" data-filter="high-risk">
                <div class="risk-indicator risk-high"></div>Risque élevé
            </div>
            <div class="filter-chip" data-filter="recent">
                <i class="fas fa-clock"></i>Récents
            </div>
            <div class="filter-chip" data-filter="follow-up">
                <i class="fas fa-calendar-check"></i>Suivi
            </div>
        </div>
        
    <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Tri:</label>
            <select id="sortSelect" class="form-select" style="min-width: 150px;">
                <option value="name">Nom A-Z</option>
                <option value="date">Date récente</option>
                <option value="risk">Niveau de risque</option>
                <option value="analyses">Nb d'analyses</option>
                <option value="age">Âge</option>
            </select>
        </div>
    </div>
</div>

<!-- Liste des patients -->
<div id="patientsContainer">
    <div class="patient-grid" id="patientsGrid">
        <!-- Loading skeleton -->
        <div class="patient-card p-6">
            <div class="flex items-center space-x-4 mb-4">
                <div class="skeleton w-12 h-12 rounded-full"></div>
                <div class="flex-1">
                    <div class="skeleton h-4 w-3/4 mb-2"></div>
                    <div class="skeleton h-3 w-1/2"></div>
                </div>
            </div>
            <div class="space-y-3">
                <div class="skeleton h-3 w-full"></div>
                <div class="skeleton h-3 w-2/3"></div>
            </div>
        </div>
        
        <!-- Répéter le skeleton pour l'effet de chargement -->
        <div class="patient-card p-6">
            <div class="flex items-center space-x-4 mb-4">
                <div class="skeleton w-12 h-12 rounded-full"></div>
                <div class="flex-1">
                    <div class="skeleton h-4 w-3/4 mb-2"></div>
                    <div class="skeleton h-3 w-1/2"></div>
                </div>
            </div>
            <div class="space-y-3">
                <div class="skeleton h-3 w-full"></div>
                <div class="skeleton h-3 w-2/3"></div>
            </div>
        </div>
    </div>
    
    <!-- Message si aucun patient -->
    <div id="emptyState" class="hidden text-center py-12">
        <div class="dashboard-card p-8 max-w-md mx-auto">
            <i class="fas fa-user-friends text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun patient trouvé</h3>
            <p class="text-gray-600 mb-6">Commencez par ajouter votre premier patient pour le suivi médical.</p>
            <button onclick="openAddPatientModal()" class="btn-dashboard primary">
                <i class="fas fa-user-plus"></i>
                Ajouter un patient
            </button>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="flex items-center justify-between mt-8">
    <div class="text-sm text-gray-600">
        Affichage de <span id="showingStart">0</span> à <span id="showingEnd">0</span> sur <span id="totalCount">0</span> patients
    </div>
    <div class="flex space-x-2" id="paginationContainer">
        <!-- Pagination générée dynamiquement -->
    </div>
</div>

<!-- Modal d’ajout supprimé: la création se fait désormais sur la page /patients/new -->

{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let allPatients = [];
    let filteredPatients = [];
    let currentPage = 1;
    let patientsPerPage = 12;
    let currentFilter = 'all';
    let currentSort = 'name';

    // Initialisation (attendre le chargement des patients avant de calculer les stats)
    document.addEventListener('DOMContentLoaded', () => {
        (async () => {
            setupEventListeners();
            await loadPatients();
            await loadStatistics();
        })();
    });

    // Configuration des event listeners
    function setupEventListeners() {
        // Recherche en temps réel
        document.getElementById('searchInput').addEventListener('input', function(e) {
            debounce(handleSearch, 300)(e.target.value);
        });

        // Filtres
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', function() {
                handleFilter(this.dataset.filter);
            });
        });

        // Tri
        document.getElementById('sortSelect').addEventListener('change', function(e) {
            handleSort(e.target.value);
        });

    // Formulaire d'ajout patient déplacé sur /patients/new
    }

    // Chargement des patients
    async function loadPatients() {
        try {
            const response = await fetch('/api/my-patients');
            const data = await response.json();

            if (data.success) {
                allPatients = data.data;
                filteredPatients = [...allPatients];
                updatePatientsDisplay();
                updatePagination();
            }
        } catch (error) {
            console.error('Erreur lors du chargement des patients:', error);
            showError();
        }
    }

    // Chargement des statistiques
    async function loadStatistics() {
        try {
            // 1) Totaux basés sur les patients chargés
            const total = allPatients.length;

            // Nouveaux ce mois (créés depuis le 1er du mois)
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            startOfMonth.setHours(0, 0, 0, 0);

            const newThisMonth = allPatients.filter(p => {
                if (!p.created_at) return false;
                const d = new Date(p.created_at);
                return !isNaN(d) && d >= startOfMonth;
            }).length;

            // Suivi régulier: patients avec > 1 analyses
            const regularFollow = allPatients.filter(p => (p.total_analyses || 0) > 1).length;

            // 2) Alertes actives: requête API dédiée
            let activeAlerts = 0;
            try {
                const res = await fetch('/api/alerts');
                const json = await res.json();
                if (json && json.success && Array.isArray(json.data)) {
                    activeAlerts = json.data.length;
                }
            } catch (e) {
                console.warn('Impossible de récupérer les alertes actives:', e);
            }

            // 3) Mise à jour de l'UI
            document.getElementById('totalPatients').textContent = total;
            document.getElementById('newPatients').textContent = newThisMonth;
            document.getElementById('activeAlerts').textContent = activeAlerts;
            document.getElementById('regularFollow').textContent = regularFollow;
        } catch (error) {
            console.error('Erreur lors du chargement des statistiques:', error);
        }
    }

    // Mise à jour de l'affichage des patients
    function updatePatientsDisplay() {
        const grid = document.getElementById('patientsGrid');
        const emptyState = document.getElementById('emptyState');

        if (filteredPatients.length === 0) {
            grid.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        grid.classList.remove('hidden');
        emptyState.classList.add('hidden');

        // Pagination
        const startIndex = (currentPage - 1) * patientsPerPage;
        const endIndex = startIndex + patientsPerPage;
        const patientsToShow = filteredPatients.slice(startIndex, endIndex);

        grid.innerHTML = patientsToShow.map(patient => createPatientCard(patient)).join('');
        
        // Animation d'entrée
        const cards = grid.querySelectorAll('.patient-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.4s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });

        updatePaginationInfo();
    }

    // Création d'une carte patient
        function createPatientCard(patient) {
        const riskLevel = calculateRiskLevel(patient);
        const initials = getInitials(patient.patient_name);
        const lastAnalysis = patient.last_analysis_date ? new Date(patient.last_analysis_date) : null;
        const analysisCount = patient.total_analyses || 0;
                const age = patient.date_of_birth ? `${calculateAge(patient.date_of_birth)} ans` : null;
                const gender = patient.gender || null;
                const phone = patient.phone || null;
                const email = patient.email || null;
                const lastConfRaw = (patient.last_confidence !== undefined && patient.last_confidence !== null) ? patient.last_confidence : null;
                const lastConf = lastConfRaw !== null ? formatPercent(lastConfRaw) : null;
                const lastConfNum = lastConfRaw !== null ? normalizePercent(lastConfRaw) : null;

    return `
                        <div class="patient-card p-6 animate-fade-in risk-${riskLevel}" onclick="viewPatient('${patient.patient_id}')">
                <!-- En-tête patient -->
                <div class="flex items-center space-x-4 mb-4">
                    <div class="patient-avatar">
                        ${initials}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <h3 class="font-semibold text-gray-900 truncate">${patient.patient_name}</h3>
                            <div class="risk-indicator risk-${riskLevel}" title="Niveau de risque: ${riskLevel}"></div>
                        </div>
                        <p class="text-sm text-gray-500">ID: ${patient.patient_id}</p>
                                                <div class="mt-1 flex items-center gap-2 flex-wrap">
                                                    ${age ? `<span class="info-chip"><i class=\"fas fa-cake-candles\"></i>${age}</span>` : ''}
                                                    ${gender ? `<span class="info-chip"><i class=\"fas fa-venus-mars\"></i>${gender}</span>` : ''}
                                                </div>
                    </div>
                    <div class="text-right">
                        <button onclick="event.stopPropagation(); openPatientMenu('${patient.patient_id}')" class="text-gray-400 hover:text-gray-600 p-2">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>

                <!-- Informations médicales -->
                <div class="space-y-3 mb-4">
                    ${renderAlertLamp(patient)}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">Analyses totales</span>
                        <span class="font-medium">${analysisCount}</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">Dernière analyse</span>
                        <span class="font-medium">${lastAnalysis ? formatDate(lastAnalysis) : 'Jamais'}</span>
                    </div>
                    ${patient.last_diagnosis ? `
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">Dernier diagnostic</span>
                        <span class="badge ${getDiagnosticBadge(patient.last_diagnosis)}">${patient.last_diagnosis}</span>
                    </div>
                    ` : ''}
                                        ${lastConf !== null ? `
                                        <div class="text-sm">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-gray-600">Confiance dernière IA</span>
                                                    <span class="font-semibold">${lastConf}</span>
                                                </div>
                                                <div class="confidence-bar mt-1">
                                                    <div class="confidence-indicator" style="width: ${lastConfNum}%;"></div>
                                                </div>
                                        </div>
                                        ` : ''}
                </div>

                                ${phone || email ? `
                                <div class="contact-row mb-4">
                                    ${phone ? `<div class=\"contact-item\"><i class=\"fas fa-phone\"></i><span>${phone}</span></div>` : ''}
                                    ${email ? `<div class=\"contact-item\"><i class=\"fas fa-envelope\"></i><span class=\"truncate\">${email}</span></div>` : ''}
                                </div>
                                ` : ''}

                <!-- Actions rapides -->
                <div class="flex space-x-2 pt-3 border-t border-gray-100">
                    <button onclick="event.stopPropagation(); newAnalysis('${patient.patient_id}')" 
                            class="btn-dashboard primary text-xs flex-1 justify-center">
                        <i class="fas fa-brain"></i>
                        Nouvelle analyse
                    </button>
                    <button onclick="event.stopPropagation(); viewHistory('${patient.patient_id}')" 
                            class="btn-dashboard secondary text-xs">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </div>
        `;
    }
    

    // Fonctions utilitaires
    function getInitials(name) {
        if (!name || typeof name !== 'string') return '??';
        const parts = name.trim().split(/\s+/).filter(Boolean);
        if (parts.length === 0) return '??';
        const initials = parts.slice(0, 2).map(n => n.charAt(0)).join('');
        return initials.toUpperCase();
    }

    function calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    }

    // Normalisation % (gère 0–1 et 0–100)
    function normalizePercent(value) {
        if (value == null) return null;
        let n = (typeof value === 'string') ? parseFloat(value.replace('%','').trim()) : Number(value);
        if (Number.isNaN(n)) return null;
        if (n > 0 && n <= 1) n = n * 100;
        if (n < 0) n = 0; if (n > 100) n = 100;
        return n;
    }
    function formatPercent(value, decimals = 1) {
        const n = normalizePercent(value);
        return (n == null) ? null : `${n.toFixed(decimals)}%`;
    }

    function calculateRiskLevel(patient) {
        // Logique de calcul du risque basée sur l'historique
        if (patient.total_analyses > 5 && patient.last_diagnosis !== 'Normal') {
            return 'high';
        } else if (patient.total_analyses > 2) {
            return 'medium';
        }
        return 'low';
    }

    // Alertes: helpers mapping couleur/label + rendu du chip
    function getAlertSeverityClass(sev) {
        switch ((sev || '').toLowerCase()) {
            case 'high':
            case 'critique':
            case 'eleve':
            case 'élevé':
                return 'alert-sev-high';
            case 'medium':
            case 'moyen':
                return 'alert-sev-medium';
            case 'low':
            case 'faible':
            case 'info':
                return 'alert-sev-low';
            default:
                return 'alert-sev-none';
        }
    }

    function getAlertSeverityLabel(sev) {
        switch ((sev || '').toLowerCase()) {
            case 'high':
            case 'critique':
            case 'eleve':
            case 'élevé':
                return 'Alerte élevée';
            case 'medium':
            case 'moyen':
                return 'Alerte moyenne';
            case 'low':
            case 'faible':
            case 'info':
                return 'Alerte faible';
            default:
                return 'Aucune alerte';
        }
    }

    function getAlertLampClass(sev) {
        switch ((sev || '').toLowerCase()) {
            case 'high':
            case 'critique':
            case 'eleve':
            case 'élevé':
                return 'lamp-high';
            case 'medium':
            case 'moyen':
                return 'lamp-medium';
            case 'low':
            case 'faible':
            case 'info':
                return 'lamp-low';
            default:
                return 'lamp-none';
        }
    }

    function renderAlertLamp(patient) {
        const count = patient.active_alerts ?? patient.alerts_count ?? 0;
        const sev = patient.last_alert_severity ?? (count > 0 ? 'medium' : 'none');
        const lampCls = getAlertLampClass(sev);
        const label = getAlertSeverityLabel(sev);
        return `<div class="flex items-center justify-between text-sm">
            <span class="text-gray-600">Alertes</span>
            <span class="alert-lamp" title="${label}">
                <span class="alert-lamp-dot ${lampCls} ${count ? 'lamp-pulse' : ''}"></span>
                <span class="text-gray-700 font-semibold">${count || 0}</span>
            </span>
        </div>`;
    }

    function renderAlertChip(patient) {
        const count = patient.active_alerts ?? patient.alerts_count ?? 0;
        const sev = patient.last_alert_severity ?? (count > 0 ? 'medium' : 'none');
        const cls = getAlertSeverityClass(sev);
        const label = getAlertSeverityLabel(sev);
        // Masquer si aucune alerte active
        if (!count) {
            return `<div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Alertes</span>
                <span class="alert-chip alert-sev-none"><i class=\"fas fa-check-circle\"></i> Aucune</span>
            </div>`;
        }
        const icon = (cls === 'alert-sev-high') ? 'fa-exclamation-circle' : (cls === 'alert-sev-medium') ? 'fa-exclamation-triangle' : 'fa-info-circle';
        return `<div class="flex items-center justify-between text-sm">
            <span class="text-gray-600">Alertes</span>
            <span class="alert-chip ${cls}"><i class="fas ${icon}"></i> ${label} • ${count}</span>
        </div>`;
    }

    function getDiagnosticBadge(diagnosis) {
        const badges = {
            'Normal': 'success',
            'Gliome': 'danger',
            'Méningiome': 'info',
            'Tumeur pituitaire': 'warning'
        };
        return badges[diagnosis] || 'secondary';
    }

    function formatDate(date) {
        if (!date) return '-';
        const d = (date instanceof Date) ? date : new Date(date);
        if (isNaN(d.getTime())) return '-';
        const now = new Date();
        const diffMs = now.getTime() - d.getTime();
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return "Aujourd'hui";
        if (diffDays === 1) return "Hier";
        if (diffDays < 7) return `Il y a ${diffDays} jours`;
        if (diffDays < 30) return `Il y a ${Math.floor(diffDays / 7)} semaines`;
        try { return d.toLocaleDateString('fr-FR'); } catch { return '-'; }
    }

    // Gestion des filtres et recherche
    function handleSearch(query) {
        const searchTerm = query.toLowerCase().trim();
        
        if (searchTerm === '') {
            filteredPatients = [...allPatients];
        } else {
            filteredPatients = allPatients.filter(patient => 
                (patient.patient_name && patient.patient_name.toLowerCase().includes(searchTerm)) ||
                (patient.patient_id && patient.patient_id.toLowerCase().includes(searchTerm)) ||
                (patient.last_diagnosis && patient.last_diagnosis.toLowerCase().includes(searchTerm)) ||
                (patient.phone && String(patient.phone).toLowerCase().includes(searchTerm)) ||
                (patient.email && patient.email.toLowerCase().includes(searchTerm))
            );
        }
        
        currentPage = 1;
        updatePatientsDisplay();
        updatePagination();
    }

    function handleFilter(filter) {
        // Mise à jour de l'UI des filtres
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
        
        currentFilter = filter;
        
        // Application du filtre
        switch (filter) {
            case 'all':
                filteredPatients = [...allPatients];
                break;
            case 'high-risk':
                filteredPatients = allPatients.filter(patient => calculateRiskLevel(patient) === 'high');
                break;
            case 'recent':
                const lastWeek = new Date();
                lastWeek.setDate(lastWeek.getDate() - 7);
                filteredPatients = allPatients.filter(patient => 
                    patient.last_analysis_date && new Date(patient.last_analysis_date) >= lastWeek
                );
                break;
            case 'follow-up':
                filteredPatients = allPatients.filter(patient => patient.total_analyses > 1);
                break;
        }
        
        currentPage = 1;
        updatePatientsDisplay();
        updatePagination();
    }

    function handleSort(sortBy) {
        currentSort = sortBy;
        
        filteredPatients.sort((a, b) => {
            switch (sortBy) {
                case 'name':
                    return a.patient_name.localeCompare(b.patient_name);
                case 'date':
                    return new Date(b.last_analysis_date || 0) - new Date(a.last_analysis_date || 0);
                case 'risk':
                    const riskOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                    return riskOrder[calculateRiskLevel(b)] - riskOrder[calculateRiskLevel(a)];
                case 'analyses':
                    return (b.total_analyses || 0) - (a.total_analyses || 0);
                case 'age':
                    const ageA = a.date_of_birth ? calculateAge(a.date_of_birth) : -1;
                    const ageB = b.date_of_birth ? calculateAge(b.date_of_birth) : -1;
                    return ageB - ageA; // du plus âgé au plus jeune
                default:
                    return 0;
            }
        });
        
        updatePatientsDisplay();
    }

    // Gestion de la pagination
    function updatePagination() {
        const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
        const container = document.getElementById('paginationContainer');
        
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Bouton précédent
        paginationHTML += `
            <button onclick="changePage(${currentPage - 1})" 
                    class="btn-dashboard secondary text-xs" 
                    ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>
        `;
        
        // Pages
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="btn-dashboard primary text-xs">${i}</button>`;
            } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 1) {
                paginationHTML += `<button onclick="changePage(${i})" class="btn-dashboard secondary text-xs">${i}</button>`;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                paginationHTML += `<span class="text-gray-400 px-2">...</span>`;
            }
        }
        
        // Bouton suivant
        paginationHTML += `
            <button onclick="changePage(${currentPage + 1})" 
                    class="btn-dashboard secondary text-xs" 
                    ${currentPage === totalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
        
        container.innerHTML = paginationHTML;
    }

    function changePage(page) {
        const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            updatePatientsDisplay();
            updatePagination();
        }
    }

    function updatePaginationInfo() {
        const startIndex = (currentPage - 1) * patientsPerPage + 1;
        const endIndex = Math.min(currentPage * patientsPerPage, filteredPatients.length);
        
        document.getElementById('showingStart').textContent = startIndex;
        document.getElementById('showingEnd').textContent = endIndex;
        document.getElementById('totalCount').textContent = filteredPatients.length;
    }

    // Actions sur les patients
    function viewPatient(patientId) {
        window.location.href = `/patient/${patientId}`;
    }

    function newAnalysis(patientId) {
        sessionStorage.setItem('preselectedPatient', patientId);
    window.location.href = '{{ url_for("new_analysis_page") }}';
    }

    function viewHistory(patientId) {
        window.location.href = `/patient/${patientId}#history`;
    }

    function openPatientMenu(patientId) {
        // Implémenter le menu contextuel
        showNotification('Menu patient - En développement', 'info');
    }

    // Gestion du modal d'ajout patient
    // Fonctions de modal d'ajout supprimées — création déportée sur /patients/new

    // Export
    function exportPatients() {
        const csv = generateCSV(filteredPatients);
        downloadCSV(csv, 'patients_' + new Date().toISOString().split('T')[0] + '.csv');
        showNotification('Export terminé', 'success');
    }

    function generateCSV(patients) {
        const headers = ['ID', 'Nom', 'Date Naissance', 'Sexe', 'Téléphone', 'Analyses', 'Dernière Analyse'];
        const rows = patients.map(p => [
            p.patient_id,
            p.patient_name,
            p.date_of_birth || '',
            p.gender || '',
            p.phone || '',
            p.total_analyses || 0,
            p.last_analysis_date || ''
        ]);
        
        return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.setAttribute('href', URL.createObjectURL(blob));
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showError() {
        const grid = document.getElementById('patientsGrid');
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="dashboard-card p-8">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Erreur de chargement</h3>
                    <p class="text-gray-600 mb-6">Impossible de charger la liste des patients.</p>
                    <button onclick="loadPatients()" class="btn-dashboard primary">
                        <i class="fas fa-sync-alt"></i>
                        Réessayer
                    </button>
                </div>
            </div>
        `;
    }

    // Utilitaire debounce
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
</script>
{% endblock %}
