{% extends "base_dashboard.html" %}

{% block title %}Profil Patient | NeuroScan PRO{% endblock %}
{% block page_subtitle %}Espace Pro{% endblock %}
{% block page_title %}Profil de {{ patient.patient_name }}{% endblock %}
{% block page_description %}Vue unifiée et professionnelle du patient{% endblock %}

{% block extra_css %}
<style>
  .pro-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
  @media (min-width: 1024px) { .pro-grid { grid-template-columns: 340px 1fr; } }
  .pro-card { background: #fff; border-radius: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.06); border: 1px solid #eef2f7; }
  .pro-card .hd { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display:flex; align-items:center; gap:10px; }
  .pro-card .bd { padding: 16px 20px; }
  .avatar { width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg,#93c5fd,#3b82f6); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size: 24px; }
  .kpi { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:12px; }
  .kpi .item { background: #0f172a; color:#fff; border-radius: 12px; padding: 14px; }
  .kpi .val { font-size: 22px; font-weight: 800; }
  .badge { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight:600; }
  .badge.low { background:#ecfeff; color:#155e75; }
  .badge.mod { background:#fff7ed; color:#9a3412; }
  .badge.high { background:#fef2f2; color:#991b1b; }
  .chip { background:#f1f5f9; color:#0f172a; padding:4px 10px; border-radius:999px; font-size:12px; }
  .tab { display:flex; gap:8px; }
  .tab button { padding:8px 12px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-weight:600; }
  .tab button.active { background:#0ea5e9; border-color:#0ea5e9; color:#fff; }
  .table { width:100%; border-collapse:separate; border-spacing:0 8px; }
  .table th { text-align:left; padding:8px 10px; color:#64748b; font-size:12px; text-transform:uppercase; letter-spacing:.04em; }
  .table td { background:#fff; padding:12px 10px; border-top:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0; }
  .table tr td:first-child { border-left:1px solid #e2e8f0; border-top-left-radius:12px; border-bottom-left-radius:12px; }
  .table tr td:last-child { border-right:1px solid #e2e8f0; border-top-right-radius:12px; border-bottom-right-radius:12px; }
  .spark { height: 60px; }
  .actions { display:flex; gap:10px; }
  .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #e2e8f0; background:#fff; font-weight:600; }
  .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
  .btn.ghost { background:#fff; }
  .grid-2 { display: grid; gap: 16px; grid-template-columns: 1fr; }
  @media (min-width: 1024px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
  .list { display:grid; gap:10px; }
  .note { background:#f8fafc; border:1px dashed #cbd5e1; border-radius:12px; padding:12px; }
  canvas { max-width: 100%; }
</style>
{% endblock %}

{% block page_actions %}
<div class="actions">
  <button class="btn ghost" id="btn-export"><i class="fas fa-download"></i>Exporter</button>
  <button class="btn primary" id="btn-new-analysis"><i class="fas fa-plus"></i>Nouvelle analyse</button>
</div>
{% endblock %}

{% block content %}
<div class="pro-grid">
  <!-- Colonne gauche: Patient card -->
  <div class="pro-card">
    <div class="hd">
      <div class="avatar">{{ patient.patient_name[:2] if patient.patient_name else 'PT' }}</div>
      <div>
        <div class="text-xl font-bold text-gray-900">{{ patient.patient_name }}</div>
        <div class="text-gray-500 text-sm">ID: {{ patient.patient_id }}</div>
      </div>
      <div class="ml-auto">
        <span class="badge {{ 'low' if patient.risk_level == 'Faible' else 'mod' if patient.risk_level == 'Modéré' else 'high' }}">
          <i class="fas fa-shield-heart"></i> Risque: {{ patient.risk_level or 'N/A' }}
        </span>
      </div>
    </div>
    <div class="bd">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="text-xs text-gray-500">Naissance</div>
          <div class="font-semibold">{{ patient.date_of_birth.strftime('%d/%m/%Y') if patient.date_of_birth else '—' }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Sexe</div>
          <div class="font-semibold">{{ patient.gender or '—' }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Téléphone</div>
          <div class="font-semibold">{{ patient.phone or '—' }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Email</div>
          <div class="font-semibold">{{ patient.email or '—' }}</div>
        </div>
      </div>
      <hr class="my-4">
      <div class="grid grid-cols-3 gap-3">
        <div class="note">
          <div class="text-xs text-gray-500">1ère analyse</div>
          <div class="font-semibold">{{ patient.first_analysis_date.strftime('%d/%m/%Y') if patient.first_analysis_date else '—' }}</div>
        </div>
        <div class="note">
          <div class="text-xs text-gray-500">Dernière analyse</div>
          <div class="font-semibold">{{ patient.last_analysis_date.strftime('%d/%m/%Y') if patient.last_analysis_date else '—' }}</div>
        </div>
        <div class="note">
          <div class="text-xs text-gray-500">Total</div>
          <div class="font-semibold">{{ patient.total_analyses or analyses|length }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Colonne droite: contenu -->
  <div class="space-y-4">
    <!-- KPIs -->
    <div class="kpi">
      <div class="item">
        <div class="text-xs opacity-70">Analyses</div>
        <div class="val">{{ analyses|length }}</div>
      </div>
      <div class="item">
        <div class="text-xs opacity-70">Normal</div>
        <div class="val">{{ normal_count }}</div>
      </div>
      <div class="item">
        <div class="text-xs opacity-70">Anormal</div>
        <div class="val">{{ abnormal_count }}</div>
      </div>
      <div class="item">
        <div class="text-xs opacity-70">Confiance moy.</div>
        <div class="val">{{ ('%.1f' % (analyses|map(attribute='confidence')|sum / (analyses|length if analyses|length>0 else 1) * 100)) if analyses|length>0 else '—' }}%</div>
      </div>
    </div>

    <!-- Onglets -->
    <div class="pro-card">
      <div class="hd">
        <div class="tab">
          <button class="active" data-tab="evolution">Evolution</button>
          <button data-tab="analyses">Analyses</button>
          <button data-tab="notes">Notes</button>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <span class="chip">Dernière mise à jour: {{ current_date.strftime('%d/%m/%Y') }}</span>
        </div>
      </div>
      <div class="bd">
        <div id="tab-evolution">
          <canvas id="evolutionChart" height="120"></canvas>
        </div>
        <div id="tab-analyses" class="hidden">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Diagnostic</th>
                <th>Confiance</th>
                <th>Image</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for a in analyses %}
              <tr>
                <td>{{ a.exam_date or a.date_uploaded.strftime('%Y-%m-%d') }}</td>
                <td>{{ a.predicted_label }}</td>
                <td>{{ '%.1f' % (a.confidence*100) }}%</td>
                <td><a class="text-blue-600 hover:underline" href="{{ a.image_path }}" target="_blank">Voir</a></td>
                <td><button class="btn ghost" data-open="{{ a.id }}"><i class="fas fa-file-medical"></i></button></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="tab-notes" class="hidden">
          <div class="grid-2">
            <div class="pro-card">
              <div class="hd"><i class="fas fa-clipboard-list"></i><b>Recommandations</b></div>
              <div class="bd list">
                {% set latest = analyses[0] if analyses|length>0 else none %}
                {% for r in (latest.recommendations if latest and latest.recommendations else []) %}
                <div class="note">
                  <i class="fas fa-check-circle text-green-600"></i>
                  <span>{{ r }}</span>
                </div>
                {% else %}
                <div class="text-gray-500">Aucune recommandation disponible.</div>
                {% endfor %}
              </div>
            </div>
            <div class="pro-card">
              <div class="hd"><i class="fas fa-notes-medical"></i><b>Notes médicales</b></div>
              <div class="bd">
                <p class="text-gray-700">{{ latest.description if latest and latest.description else '—' }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Données pour JS -->
<script id="analyses-data" type="application/json">{{ analyses_json|safe }}</script>
{% endblock %}

{% block extra_js %}
<script>
  const tabs = document.querySelectorAll('.tab button');
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-evolution').classList.toggle('hidden', btn.dataset.tab !== 'evolution');
    document.getElementById('tab-analyses').classList.toggle('hidden', btn.dataset.tab !== 'analyses');
    document.getElementById('tab-notes').classList.toggle('hidden', btn.dataset.tab !== 'notes');
  }));

  const raw = document.getElementById('analyses-data')?.textContent || '[]';
  let data = [];
  try { data = JSON.parse(raw); } catch(e) { data = []; }
  
  const ctx = document.getElementById('evolutionChart');
  if (ctx && window.Chart) {
    const labels = data.map(d => new Date(d.date_uploaded).toLocaleDateString('fr-FR'));
    const series = data.map(d => Math.round(d.confidence * 1000) / 10);
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{
        label: 'Confiance (%)',
        data: series,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,.15)',
        tension: .35, fill: true, pointRadius: 3
      }]},
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, suggestedMax: 100 } }
      }
    });
  }

  document.getElementById('btn-export')?.addEventListener('click', () => {
    const exportData = {
      patient: {
        id: '{{ patient.patient_id }}',
        name: '{{ patient.patient_name }}',
        risk: '{{ patient.risk_level }}'
      },
      analyses: data
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `rapport_{{ patient.patient_id }}.json`; a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btn-new-analysis')?.addEventListener('click', () => {
    window.location.href = "{{ url_for('dashboard') }}#upload";
  });
</script>
{% endblock %}
