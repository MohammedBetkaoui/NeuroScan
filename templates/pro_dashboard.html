{% extends "base_dashboard.html" %}

{% block title %}Tableau de Bord Pro - NeuroScan{% endblock %}

{% block page_subtitle %}Analyse & Statistiques{% endblock %}

{% block page_title %}Tableau de Bord Professionnel{% endblock %}

{% block page_description %}Analyses détaillées, statistiques avancées et tendances de vos diagnostics{% endblock %}

{% block extra_css %}
<style>
    /* Stat cards avec gradients modernes */
    .stat-card-gradient {
        position: relative;
        overflow: hidden;
        border-radius: var(--radius-xl);
        transition: var(--transition-normal);
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .stat-card-gradient::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        z-index: 1;
    }

    .stat-card-gradient > * {
        position: relative;
        z-index: 2;
    }

    .stat-card-gradient:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: var(--shadow-2xl);
    }

    .stat-card-gradient.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card-gradient.green {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .stat-card-gradient.purple {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card-gradient.orange {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    }

    /* Graphiques */
    .chart-container {
        position: relative;
        height: 300px;
        background: var(--surface-primary);
        border-radius: var(--radius-xl);
        padding: 24px;
        box-shadow: var(--shadow-medium);
        border: 1px solid rgba(229, 231, 235, 0.3);
    }

    /* Cartes patients expandables */
    .patient-analysis-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: stretch;
    }

    .expandable-card {
        display: flex;
        flex-direction: column;
        min-height: 400px;
        max-height: 600px;
    }

    .expandable-card .dashboard-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .scrollable-content {
        flex: 1;
        overflow-y: auto;
        max-height: 400px;
        padding-right: 8px;
    }

    .scrollable-content::-webkit-scrollbar {
        width: 6px;
    }

    .scrollable-content::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .scrollable-content::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .scrollable-content::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .chart-responsive {
        position: relative;
        min-height: 200px;
        max-height: 300px;
    }

    /* Navigation responsive */
    .dashboard-nav {
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .dashboard-nav::-webkit-scrollbar {
        display: none;
    }

    .dashboard-nav-item {
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Tables responsives */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: var(--radius-xl);
    }

    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    /* Action buttons responsive */
    .page-actions-responsive {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Mobile-first stats grid */
    .stats-grid-mobile {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
    }

    /* Chart controls responsive */
    .chart-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }

    /* Mobile cards adjustments */
    .mobile-card {
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
    }

    /* Advanced grid responsive */
    .advanced-grid-mobile {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }

    /* Responsive */
    @media (min-width: 480px) {
        .stats-grid-mobile {
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
    }

    @media (min-width: 768px) {
        .stats-grid-mobile {
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }
        
        .advanced-grid-mobile {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .chart-container {
            height: 280px;
            padding: 20px;
        }
    }

    @media (min-width: 1024px) {
        .stats-grid-mobile {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .advanced-grid-mobile {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .patient-analysis-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .chart-container {
            height: 300px;
            padding: 24px;
        }
    }

    @media (max-width: 768px) {
        .stat-card-gradient:hover {
            transform: none;
            box-shadow: var(--shadow-medium);
        }
        
        .chart-container {
            height: 250px;
            padding: 16px;
        }
        
        .patient-analysis-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .expandable-card {
            min-height: 300px;
            max-height: 500px;
        }
        
        .dashboard-nav {
            margin: 0 -16px;
            padding: 0 16px;
        }
        
        .page-actions-responsive {
            justify-content: center;
            width: 100%;
        }
        
        .page-actions-responsive .btn-dashboard {
            flex: 1;
            min-width: 120px;
            max-width: 150px;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .stat-card-gradient {
            padding: 20px !important;
        }
        
        .stat-card-gradient .text-3xl {
            font-size: 1.875rem;
        }
        
        .dashboard-card {
            padding: 16px !important;
        }
        
        .dashboard-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        
        .dashboard-card-header .flex-1 {
            width: 100%;
        }
        
        .chart-controls {
            justify-content: stretch;
        }
        
        .chart-controls .btn-dashboard {
            flex: 1;
            justify-content: center;
            min-width: 0;
        }
        
        .dashboard-card-icon {
            width: 40px;
            height: 40px;
            font-size: 18px;
        }
        
        .table-responsive {
            margin: 0 -16px;
            border-radius: 0;
        }
        
        .dashboard-table th,
        .dashboard-table td {
            padding: 12px 8px;
            font-size: 14px;
        }
        
        .badge {
            font-size: 10px;
            padding: 2px 8px;
        }
        
        .btn-dashboard.text-xs {
            font-size: 10px;
            padding: 6px 8px;
        }
    }

    /* Skeleton loading responsive */
    @media (max-width: 768px) {
        .skeleton {
            border-radius: var(--radius-md);
        }
    }

    /* Touch-friendly improvements */
    @media (max-width: 768px) {
        .btn-dashboard {
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .dashboard-nav-item {
            min-height: 44px;
            display: flex;
            align-items: center;
            padding: 12px 16px;
        }
        
        .dashboard-card.clickable {
            touch-action: manipulation;
        }
    }

    /* Improved contrast for mobile */
    @media (max-width: 768px) {
        .dashboard-card-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .dashboard-card-subtitle {
            font-size: 13px;
            margin-top: 2px;
        }
        
        .text-xs {
            font-size: 11px;
        }
        
        .text-sm {
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block secondary_nav %}
<div class="dashboard-nav mb-8">
    <a href="{{ url_for('dashboard') }}" class="dashboard-nav-item">
        <i class="fas fa-home mr-2"></i>Accueil
    </a>
    <a href="{{ url_for('pro_dashboard') }}" class="dashboard-nav-item active">
        <i class="fas fa-chart-bar mr-2"></i>Statistiques
    </a>
    <a href="{{ url_for('patients_list') }}" class="dashboard-nav-item">
        <i class="fas fa-users mr-2"></i>Patients
    </a>
    <a href="{{ url_for('platform_stats') }}" class="dashboard-nav-item">
        <i class="fas fa-globe mr-2"></i>Plateforme
    </a>
</div>
{% endblock %}

{% block page_actions %}
<div class="page-actions-responsive">
    <button onclick="exportData()" class="btn-dashboard secondary">
        <i class="fas fa-download"></i>
        <span class="hidden sm:inline">Exporter</span>
    </button>
    <button onclick="refreshData()" class="btn-dashboard primary" id="refreshBtn">
        <i class="fas fa-sync-alt"></i>
        <span class="hidden sm:inline">Actualiser</span>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Statistiques rapides -->
<div class="stats-grid mb-8">
    <div class="stat-card-gradient blue p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-sm font-medium">Analyses Totales</p>
                <p class="text-3xl font-bold" id="totalAnalyses">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-brain text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-green-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="totalAnalysesChange">+0%</span>
            </span>
            <span class="text-blue-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>

    <div class="stat-card-gradient green p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-sm font-medium">Tumeurs Détectées</p>
                <p class="text-3xl font-bold" id="tumorsDetected">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-red-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="tumorsDetectedChange">+0%</span>
            </span>
            <span class="text-green-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>

    <div class="stat-card-gradient purple p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-purple-100 text-sm font-medium">Patients Suivis</p>
                <p class="text-3xl font-bold" id="patientsCount">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-yellow-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="patientsChange">+0%</span>
            </span>
            <span class="text-purple-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>

    <div class="stat-card-gradient orange p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-orange-100 text-sm font-medium">Précision Moyenne</p>
                <p class="text-3xl font-bold" id="avgConfidence">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-target text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-yellow-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="avgConfidenceChange">+0%</span>
            </span>
            <span class="text-orange-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>
</div>

<!-- Graphiques principaux -->
<div class="dashboard-grid cols-2 mb-8">
    <!-- Graphique des analyses par période -->
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-6">
            <div class="dashboard-card-icon primary">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="flex-1">
                <h3 class="dashboard-card-title">Évolution des Analyses</h3>
                <p class="dashboard-card-subtitle">Analyses effectuées par période</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="changeTimeRange('7d')" class="btn-dashboard secondary text-xs" id="btn-7d">7j</button>
                <button onclick="changeTimeRange('30d')" class="btn-dashboard primary text-xs" id="btn-30d">30j</button>
                <button onclick="changeTimeRange('90d')" class="btn-dashboard secondary text-xs" id="btn-90d">90j</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="analysisChart"></canvas>
        </div>
    </div>

    <!-- Graphique de répartition des diagnostics -->
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-6">
            <div class="dashboard-card-icon success">
                <i class="fas fa-pie-chart"></i>
            </div>
            <div>
                <h3 class="dashboard-card-title">Répartition des Diagnostics</h3>
                <p class="dashboard-card-subtitle">Distribution par type de tumeur</p>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="diagnosticChart"></canvas>
        </div>
    </div>
</div>

<!-- Tableaux de données -->
<div class="dashboard-grid cols-1 mb-8">
    <!-- Analyses récentes -->
    <div class="dashboard-card p-0 overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="dashboard-card-header">
                <div class="dashboard-card-icon indigo">
                    <i class="fas fa-history"></i>
                </div>
                <div class="flex-1">
                    <h3 class="dashboard-card-title">Analyses Récentes</h3>
                    <p class="dashboard-card-subtitle">Dernières analyses effectuées</p>
                </div>
                <a href="{{ url_for('pro_dashboard_advanced') }}" class="btn-dashboard secondary">
                    <i class="fas fa-external-link-alt"></i>
                    Voir tout
                </a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Patient</th>
                        <th>Diagnostic</th>
                        <th>Confiance</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentAnalysesTable">
                    <!-- Données chargées dynamiquement -->
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="skeleton h-6 w-full mb-2"></div>
                            <div class="skeleton h-6 w-3/4 mx-auto"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Nouvelles analyses avancées -->
<div class="dashboard-grid cols-3 mb-8">
    <!-- Performance par heure -->
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-4">
            <div class="dashboard-card-icon purple">
                <i class="fas fa-clock"></i>
            </div>
            <div>
                <h3 class="dashboard-card-title">Performance Horaire</h3>
                <p class="dashboard-card-subtitle">Activité par heure de la journée</p>
            </div>
        </div>
        <div class="chart-container h-48">
            <canvas id="hourlyPerformanceChart"></canvas>
        </div>
    </div>

    <!-- Évolution de la confiance -->
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-4">
            <div class="dashboard-card-icon success">
                <i class="fas fa-trending-up"></i>
            </div>
            <div>
                <h3 class="dashboard-card-title">Évolution Confiance</h3>
                <p class="dashboard-card-subtitle">Tendance de précision sur 30 jours</p>
            </div>
        </div>
        <div class="chart-container h-48">
            <canvas id="confidenceEvolutionChart"></canvas>
        </div>
    </div>

    <!-- Taux de détection -->
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-4">
            <div class="dashboard-card-icon danger">
                <i class="fas fa-search"></i>
            </div>
            <div>
                <h3 class="dashboard-card-title">Taux de Détection</h3>
                <p class="dashboard-card-subtitle">Évolution mensuelle des détections</p>
            </div>
        </div>
        <div class="chart-container h-48">
            <canvas id="detectionRateChart"></canvas>
        </div>
    </div>
</div>

<!-- Analyse des patients -->
<div class="patient-analysis-grid mb-8">
    <!-- Patients à risque -->
    <div class="dashboard-card expandable-card p-6">
        <div class="dashboard-card-header mb-6">
            <div class="dashboard-card-icon warning">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="flex-1">
                <h3 class="dashboard-card-title">Patients à Risque</h3>
                <p class="dashboard-card-subtitle">Nécessitent une attention particulière</p>
            </div>
            <button onclick="viewAllPatients()" class="btn-dashboard secondary">
                <i class="fas fa-users"></i>
                Voir tout
            </button>
        </div>
        <div class="dashboard-card-content">
            <div id="highRiskPatients" class="scrollable-content space-y-3">
                <!-- Données chargées dynamiquement -->
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg animate-pulse">
                    <div class="skeleton h-4 w-1/2"></div>
                    <div class="skeleton h-4 w-16"></div>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg animate-pulse">
                    <div class="skeleton h-4 w-2/3"></div>
                    <div class="skeleton h-4 w-20"></div>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg animate-pulse">
                    <div class="skeleton h-4 w-1/3"></div>
                    <div class="skeleton h-4 w-24"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights patients -->
    <div class="dashboard-card expandable-card p-6">
        <div class="dashboard-card-header mb-6">
            <div class="dashboard-card-icon info">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div>
                <h3 class="dashboard-card-title">Répartition Patients</h3>
                <p class="dashboard-card-subtitle">Distribution par âge et genre</p>
            </div>
        </div>
        <div class="dashboard-card-content">
            <div class="grid grid-cols-2 gap-4 h-full">
                <div class="flex flex-col">
                    <h4 class="text-sm font-medium text-gray-700 mb-4">Par âge</h4>
                    <div class="chart-responsive flex-1">
                        <canvas id="ageDistributionChart" class="w-full h-full"></canvas>
                    </div>
                </div>
                <div class="flex flex-col">
                    <h4 class="text-sm font-medium text-gray-700 mb-4">Par genre</h4>
                    <div class="chart-responsive flex-1">
                        <canvas id="genderDistributionChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistiques détaillées par diagnostic -->
<div class="dashboard-grid cols-1 mb-8">
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-6">
            <div class="dashboard-card-icon primary">
                <i class="fas fa-microscope"></i>
            </div>
            <div class="flex-1">
                <h3 class="dashboard-card-title">Analyse Détaillée par Diagnostic</h3>
                <p class="dashboard-card-subtitle">Performance et statistiques par type de tumeur</p>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Type de Diagnostic</th>
                        <th>Nombre Total</th>
                        <th>Confiance Moyenne</th>
                        <th>Confiance Min/Max</th>
                        <th>Temps Moyen</th>
                        <th>Tendance</th>
                    </tr>
                </thead>
                <tbody id="diagnosticStatsTable">
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="skeleton h-6 w-full mb-2"></div>
                            <div class="skeleton h-6 w-3/4 mx-auto"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Alertes et notifications -->
<div class="dashboard-grid cols-1">
    <div class="dashboard-card p-6 bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200">
        <div class="dashboard-card-header">
            <div class="dashboard-card-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="flex-1">
                <h3 class="dashboard-card-title text-amber-900">Alertes Médicales Actives</h3>
                <p class="dashboard-card-subtitle text-amber-700">Patients nécessitant votre attention</p>
            </div>
            <a href="{{ url_for('medical_alerts_page') }}" class="btn-dashboard warning">
                <i class="fas fa-eye"></i>
                Consulter
            </a>
        </div>
        <div class="dashboard-card-content">
            <div id="activeAlerts" class="space-y-3">
                <!-- Alertes chargées dynamiquement -->
                <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                    <div class="skeleton h-4 w-1/3"></div>
                    <div class="skeleton h-4 w-24"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Variables pour les graphiques
    let analysisChart;
    let diagnosticChart;
    let hourlyPerformanceChart;
    let confidenceEvolutionChart;
    let detectionRateChart;
    let ageDistributionChart;
    let genderDistributionChart;
    let currentTimeRange = '30d';

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        loadStatistics();
        loadRecentAnalyses();
        loadActiveAlerts();
        loadAdvancedStats();
        loadPatientInsights();
        
        // Actualisation automatique toutes les 5 minutes
        setInterval(refreshData, 300000);
    });

    // Initialisation des graphiques
    function initializeCharts() {
        // Graphique d'évolution des analyses
        const analysisCtx = document.getElementById('analysisChart').getContext('2d');
        analysisChart = new Chart(analysisCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Analyses',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });

        // Graphique de répartition des diagnostics
        const diagnosticCtx = document.getElementById('diagnosticChart').getContext('2d');
        diagnosticChart = new Chart(diagnosticCtx, {
            type: 'doughnut',
            data: {
                labels: ['Normal', 'Gliome', 'Méningiome', 'Tumeur pituitaire'],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(245, 158, 11, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        // Graphique de performance horaire
        const hourlyCtx = document.getElementById('hourlyPerformanceChart').getContext('2d');
        hourlyPerformanceChart = new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Analyses',
                    data: [],
                    backgroundColor: 'rgba(139, 92, 246, 0.6)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });

        // Graphique d'évolution de la confiance
        const confidenceCtx = document.getElementById('confidenceEvolutionChart').getContext('2d');
        confidenceEvolutionChart = new Chart(confidenceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Confiance moyenne',
                    data: [],
                    borderColor: 'rgba(34, 197, 94, 1)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });

        // Graphique du taux de détection
        const detectionCtx = document.getElementById('detectionRateChart').getContext('2d');
        detectionRateChart = new Chart(detectionCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Taux de détection (%)',
                    data: [],
                    borderColor: 'rgba(239, 68, 68, 1)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });

        // Graphiques de distribution des patients
        const ageCtx = document.getElementById('ageDistributionChart').getContext('2d');
        ageDistributionChart = new Chart(ageCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(139, 92, 246, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        const genderCtx = document.getElementById('genderDistributionChart').getContext('2d');
        genderDistributionChart = new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                        'rgba(156, 163, 175, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Chargement des statistiques
    async function loadStatistics() {
        try {
            const response = await fetch('/api/pro-dashboard/overview');
            const data = await response.json();

            if (data.success) {
                updateStatistics(data.data);
            } else {
                console.error('Erreur API:', data.error);
                showNotification('Erreur lors du chargement des statistiques', 'error');
            }
        } catch (error) {
            console.error('Erreur lors du chargement des statistiques:', error);
            showNotification('Erreur de connexion', 'error');
        }
    }

    // Mise à jour des statistiques
    function updateStatistics(stats) {
        document.getElementById('totalAnalyses').textContent = stats.total_analyses || 0;
        document.getElementById('tumorsDetected').textContent = stats.tumors_detected || 0;
        document.getElementById('patientsCount').textContent = stats.patients_count || 0;
        document.getElementById('avgConfidence').textContent = ((stats.avg_confidence || 0) * 100).toFixed(1) + '%';

        // Mise à jour des changements avec données réelles
        const changes = stats.changes || {};
        document.getElementById('totalAnalysesChange').textContent = formatChange(changes.analyses_change || 0);
        document.getElementById('tumorsDetectedChange').textContent = formatChange(changes.tumors_change || 0);
        document.getElementById('patientsChange').textContent = formatChange(changes.patients_change || 0);
        document.getElementById('avgConfidenceChange').textContent = formatChange(changes.confidence_change || 0);

        // Mise à jour des graphiques
        updateCharts(stats);
    }

    // Fonction pour formater les changements avec signe et couleur
    function formatChange(value) {
        const sign = value >= 0 ? '+' : '';
        return sign + value.toFixed(1) + '%';
    }

    // Mise à jour des graphiques
    function updateCharts(stats) {
        // Utiliser les données réelles pour le graphique d'évolution
        if (stats.daily_analyses && stats.daily_analyses.length > 0) {
            const labels = [];
            const data = [];
            
            stats.daily_analyses.forEach(item => {
                const date = new Date(item[0]);
                labels.push(date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }));
                data.push(item[1]);
            });

            analysisChart.data.labels = labels;
            analysisChart.data.datasets[0].data = data;
        } else {
            // Fallback avec données par défaut si pas de données
            analysisChart.data.labels = ['Aucune donnée'];
            analysisChart.data.datasets[0].data = [0];
        }
        analysisChart.update();

        // Données réelles pour le graphique de répartition
        diagnosticChart.data.datasets[0].data = [
            stats.normal_count || 0,
            stats.glioma_count || 0,
            stats.meningioma_count || 0,
            stats.pituitary_count || 0
        ];
        diagnosticChart.update();
    }

    // Chargement des analyses récentes
    async function loadRecentAnalyses() {
        try {
            const response = await fetch('/api/pro-dashboard/recent-analyses');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                const tableBody = document.getElementById('recentAnalysesTable');
                tableBody.innerHTML = data.data.map(analysis => `
                    <tr class="hover:bg-gray-50 transition-colors duration-200">
                        <td class="font-medium">${formatDate(analysis.timestamp)}</td>
                        <td>${analysis.patient_name}</td>
                        <td>
                            <span class="badge ${getBadgeClass(analysis.predicted_label)}">
                                ${analysis.predicted_label}
                            </span>
                        </td>
                        <td class="font-mono">${(analysis.confidence * 100).toFixed(1)}%</td>
                        <td>
                            <span class="badge ${analysis.confidence > 0.9 ? 'success' : analysis.confidence > 0.7 ? 'warning' : 'danger'}">
                                ${analysis.confidence > 0.9 ? 'Fiable' : analysis.confidence > 0.7 ? 'Modéré' : 'Incertain'}
                            </span>
                        </td>
                        <td>
                            <button onclick="viewAnalysis(${analysis.id})" class="btn-dashboard secondary text-xs">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('recentAnalysesTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
                            <p>Aucune analyse récente</p>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erreur lors du chargement des analyses récentes:', error);
            showNotification('Erreur lors du chargement des analyses', 'error');
        }
    }

    // Chargement des alertes actives
    async function loadActiveAlerts() {
        try {
            const response = await fetch('/api/alerts');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                const alertsContainer = document.getElementById('activeAlerts');
                alertsContainer.innerHTML = data.data.slice(0, 3).map(alert => `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-amber-200">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-${getSeverityIcon(alert.severity)} text-${getSeverityColor(alert.severity)}"></i>
                            <div>
                                <p class="font-medium text-gray-900 text-sm">${alert.title}</p>
                                <p class="text-gray-600 text-xs">${alert.patient_name} - ${formatDate(alert.created_at)}</p>
                            </div>
                        </div>
                        <button onclick="viewAlert(${alert.id})" class="btn-dashboard secondary text-xs">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `).join('');
            } else {
                document.getElementById('activeAlerts').innerHTML = `
                    <div class="text-center py-8 text-amber-700">
                        <i class="fas fa-check-circle text-4xl mb-4"></i>
                        <p>Aucune alerte active</p>
                        <p class="text-sm">Tous vos patients sont sous surveillance normale</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Erreur lors du chargement des alertes:', error);
        }
    }

    // Fonctions utilitaires
    function getBadgeClass(label) {
        switch (label) {
            case 'Normal': return 'success';
            case 'Gliome': return 'danger';
            case 'Méningiome': return 'info';
            case 'Tumeur pituitaire': return 'warning';
            default: return 'secondary';
        }
    }

    function getSeverityIcon(severity) {
        switch (severity) {
            case 'high': return 'exclamation-triangle';
            case 'medium': return 'exclamation-circle';
            case 'low': return 'info-circle';
            default: return 'bell';
        }
    }

    function getSeverityColor(severity) {
        switch (severity) {
            case 'high': return 'red-500';
            case 'medium': return 'amber-500';
            case 'low': return 'blue-500';
            default: return 'gray-500';
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Actions
    async function changeTimeRange(range) {
        currentTimeRange = range;
        
        // Mise à jour des boutons
        document.querySelectorAll('[id^="btn-"]').forEach(btn => {
            btn.className = 'btn-dashboard secondary text-xs';
        });
        document.getElementById('btn-' + range).className = 'btn-dashboard primary text-xs';
        
        // Charger les données pour la période sélectionnée
        try {
            const response = await fetch(`/api/pro-dashboard/time-range/${range}`);
            const data = await response.json();
            
            if (data.success) {
                // Mettre à jour le graphique avec les nouvelles données
                analysisChart.data.labels = data.data.labels;
                analysisChart.data.datasets[0].data = data.data.data;
                analysisChart.update();
            }
        } catch (error) {
            console.error('Erreur lors du changement de période:', error);
            // Fallback: recharger les statistiques générales
            loadStatistics();
        }
    }

    function refreshData() {
        const refreshBtn = document.getElementById('refreshBtn');
        const icon = refreshBtn.querySelector('i');
        
        // Animation de rotation
        icon.classList.add('animate-spin');
        
        // Recharger toutes les données
        Promise.all([
            loadStatistics(),
            loadRecentAnalyses(),
            loadActiveAlerts(),
            loadAdvancedStats(),
            loadPatientInsights()
        ]).finally(() => {
            icon.classList.remove('animate-spin');
            showNotification('Toutes les données actualisées', 'success');
        });
    }

    function viewAllPatients() {
        window.location.href = '/patients';
    }

    function viewPatient(patientId) {
        window.location.href = `/patient/${patientId}`;
    }

    // Chargement des statistiques avancées
    async function loadAdvancedStats() {
        try {
            const response = await fetch('/api/pro-dashboard/advanced-stats');
            const data = await response.json();

            if (data.success) {
                updateAdvancedCharts(data.data);
                updateDiagnosticStatsTable(data.data.diagnostic_stats);
                updateHighRiskPatients(data.data.high_risk_patients);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des stats avancées:', error);
        }
    }

    // Chargement des insights patients
    async function loadPatientInsights() {
        try {
            const response = await fetch('/api/pro-dashboard/patient-insights');
            const data = await response.json();

            if (data.success) {
                updatePatientDistributionCharts(data.data);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des insights patients:', error);
        }
    }

    // Mise à jour des graphiques avancés
    function updateAdvancedCharts(data) {
        // Performance horaire
        if (data.hourly_performance) {
            hourlyPerformanceChart.data.labels = data.hourly_performance.labels;
            hourlyPerformanceChart.data.datasets[0].data = data.hourly_performance.analyses_count;
            hourlyPerformanceChart.update();
        }

        // Évolution de la confiance
        if (data.confidence_evolution) {
            confidenceEvolutionChart.data.labels = data.confidence_evolution.labels;
            confidenceEvolutionChart.data.datasets[0].data = data.confidence_evolution.avg_confidence;
            confidenceEvolutionChart.update();
        }

        // Taux de détection
        if (data.detection_trends) {
            detectionRateChart.data.labels = data.detection_trends.labels;
            detectionRateChart.data.datasets[0].data = data.detection_trends.detection_rates;
            detectionRateChart.update();
        }
    }

    // Mise à jour des graphiques de distribution des patients
    function updatePatientDistributionCharts(data) {
        // Distribution par âge
        if (data.age_distribution) {
            const ageLabels = Object.keys(data.age_distribution);
            const ageData = Object.values(data.age_distribution);
            
            ageDistributionChart.data.labels = ageLabels;
            ageDistributionChart.data.datasets[0].data = ageData;
            ageDistributionChart.update();
        }

        // Distribution par genre
        if (data.gender_distribution) {
            const genderLabels = Object.keys(data.gender_distribution);
            const genderData = Object.values(data.gender_distribution);
            
            genderDistributionChart.data.labels = genderLabels;
            genderDistributionChart.data.datasets[0].data = genderData;
            genderDistributionChart.update();
        }
    }

    // Mise à jour du tableau des statistiques par diagnostic
    function updateDiagnosticStatsTable(diagnosticStats) {
        const tableBody = document.getElementById('diagnosticStatsTable');
        
        if (Object.keys(diagnosticStats).length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-8 text-gray-500">
                        <i class="fas fa-chart-bar text-4xl mb-4 opacity-50"></i>
                        <p>Aucune donnée statistique disponible</p>
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = Object.entries(diagnosticStats).map(([type, stats]) => `
            <tr class="hover:bg-gray-50 transition-colors duration-200">
                <td class="font-medium">
                    <span class="badge ${getBadgeClass(type)}">${type}</span>
                </td>
                <td class="font-mono">${stats.total_count}</td>
                <td class="font-mono">${stats.avg_confidence.toFixed(1)}%</td>
                <td class="font-mono text-sm">
                    ${stats.min_confidence.toFixed(1)}% - ${stats.max_confidence.toFixed(1)}%
                </td>
                <td class="font-mono">${stats.avg_processing_time.toFixed(2)}s</td>
                <td>
                    <div class="flex items-center">
                        ${getTrendIcon(stats.avg_confidence)}
                        <span class="ml-2 text-sm ${getTrendColor(stats.avg_confidence)}">
                            ${getTrendText(stats.avg_confidence)}
                        </span>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Mise à jour des patients à risque
    function updateHighRiskPatients(riskPatients) {
        const container = document.getElementById('highRiskPatients');
        
        if (riskPatients.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-shield-alt text-4xl mb-4 text-green-500"></i>
                    <p>Aucun patient à risque élevé</p>
                    <p class="text-sm">Tous vos patients sont sous surveillance normale</p>
                </div>
            `;
            return;
        }

        container.innerHTML = riskPatients.map(patient => `
            <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${getRiskLevelColor(patient.risk_level)}">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900">${patient.patient_name}</p>
                        <p class="text-sm text-gray-600">
                            ${patient.tumor_detections} détections - ${patient.avg_confidence}% confiance moyenne
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="badge ${getRiskLevelBadge(patient.risk_level)}">${patient.risk_level}</span>
                    <button onclick="viewPatient('${patient.patient_id}')" class="btn-dashboard secondary text-xs mt-1">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Fonctions utilitaires pour les tendances
    function getTrendIcon(confidence) {
        if (confidence >= 90) return '<i class="fas fa-arrow-up text-green-500"></i>';
        if (confidence >= 70) return '<i class="fas fa-minus text-yellow-500"></i>';
        return '<i class="fas fa-arrow-down text-red-500"></i>';
    }

    function getTrendColor(confidence) {
        if (confidence >= 90) return 'text-green-600';
        if (confidence >= 70) return 'text-yellow-600';
        return 'text-red-600';
    }

    function getTrendText(confidence) {
        if (confidence >= 90) return 'Excellent';
        if (confidence >= 70) return 'Stable';
        return 'À surveiller';
    }

    function getRiskLevelColor(level) {
        switch (level) {
            case 'Critique': return 'bg-red-500';
            case 'Élevé': return 'bg-orange-500';
            case 'Modéré': return 'bg-yellow-500';
            default: return 'bg-green-500';
        }
    }

    function getRiskLevelBadge(level) {
        switch (level) {
            case 'Critique': return 'danger';
            case 'Élevé': return 'warning';
            case 'Modéré': return 'info';
            default: return 'success';
        }
    }

    function exportData() {
        showNotification('Export en cours...', 'info');
        
        fetch('/api/pro-dashboard/export-data')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Créer et télécharger le fichier des analyses
                    downloadCSV(data.data.analyses_csv, 'analyses_' + new Date().toISOString().split('T')[0] + '.csv');
                    
                    // Créer et télécharger le fichier des patients
                    setTimeout(() => {
                        downloadCSV(data.data.patients_csv, 'patients_' + new Date().toISOString().split('T')[0] + '.csv');
                    }, 1000);
                    
                    showNotification(`Export terminé: ${data.data.total_analyses} analyses, ${data.data.total_patients} patients`, 'success');
                } else {
                    showNotification('Erreur lors de l\'export', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur export:', error);
                showNotification('Erreur lors de l\'export', 'error');
            });
    }

    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function viewAnalysis(id) {
        showNotification('Redirection vers l\'analyse...', 'info');
        // Redirection vers la page de détail de l'analyse
        window.location.href = `/analysis/${id}`;
    }

    function viewAlert(id) {
        window.location.href = '/medical-alerts#alert-' + id;
    }

    // Fonction pour afficher les notifications
    function showNotification(message, type = 'info') {
        // Créer l'élément de notification
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform translate-x-full transition-transform duration-300 ${getNotificationClass(type)}`;
        notification.textContent = message;

        // Ajouter au DOM
        document.body.appendChild(notification);

        // Animer l'entrée
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);

        // Supprimer après 4 secondes
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 4000);
    }

    function getNotificationClass(type) {
        switch (type) {
            case 'success': return 'bg-green-500';
            case 'error': return 'bg-red-500';
            case 'warning': return 'bg-amber-500';
            case 'info':
            default: return 'bg-blue-500';
        }
    }
</script>
{% endblock %}
