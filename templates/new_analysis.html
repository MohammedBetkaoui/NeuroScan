{% extends "base_dashboard.html" %}

{% block title %}Nouvelle Analyse - NeuroScan{% endblock %}
{% block page_title %}Analyse IA NeuroScan{% endblock %}
{% block page_subtitle %}Interface épurée et performante{% endblock %}
{% block page_description %}Téléversez une imagerie et obtenez un diagnostic IA fiable en quelques secondes.{% endblock %}

{% block content %}
<div class="min-h-screen bg-neutral-50 -mt-6 pt-6">
  <div class="max-w-7xl mx-auto p-6">

    <!-- Bandeau -->
    <section class="rounded-2xl p-6 bg-white border border-neutral-200 shadow-sm mb-6">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 text-white flex items-center justify-center shadow">
            <i class="fas fa-brain"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-neutral-900">NeuroScan • Nouvelle Analyse</h1>
            <p class="text-neutral-500 text-sm">Sélectionnez un patient, importez une image IRM, lancez l'analyse.</p>
          </div>
        </div>
        <div class="flex items-center gap-3 text-sm text-neutral-600">
          <i class="fas fa-shield-alt text-emerald-600"></i>
          <span>Données chiffrées</span>
          <span class="w-1 h-1 rounded-full bg-neutral-300"></span>
          <i class="fas fa-check-circle text-blue-600"></i>
          <span>Modèle validé</span>
        </div>
      </div>
    </section>

    <!-- Grille principale: Patient | Upload | Statut -->
    <section class="grid grid-cols-1 lg:grid-cols-5 gap-6">
      <!-- Patient (2) -->
      <div class="lg:col-span-2 space-y-6">
        <div class="rounded-2xl p-6 bg-white border border-neutral-200 shadow-sm">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-700 flex items-center justify-center">
              <i class="fas fa-user-md"></i>
            </div>
            <h2 class="font-semibold text-neutral-900">Patient</h2>
          </div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Sélectionnez un patient</label>
          <select id="patientSelect" class="w-full rounded-xl border border-neutral-300 bg-white px-4 py-3 text-neutral-800 shadow-inner focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400">
            <option value="">— Choisir —</option>
            {% for patient in patients %}
            <option value="{{ patient.patient_id }}" 
              data-name="{{ patient.patient_name }}" 
              data-age="{{ patient.age }}"
              data-gender="{{ patient.gender }}"
              data-dob="{{ patient.date_of_birth }}">
              {{ patient.patient_name }} — {{ patient.age }} ans ({{ patient.gender }})
            </option>
            {% endfor %}
          </select>

          <div id="patientInfo" class="hidden mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="rounded-xl border border-neutral-200 bg-neutral-50 px-4 py-3">
              <div class="text-xs text-neutral-500">Nom</div>
              <div id="patientName" class="font-semibold text-neutral-800">—</div>
            </div>
            <div class="rounded-xl border border-neutral-200 bg-neutral-50 px-4 py-3">
              <div class="text-xs text-neutral-500">Âge</div>
              <div id="patientAge" class="font-semibold text-neutral-800">—</div>
            </div>
            <div class="rounded-xl border border-neutral-200 bg-neutral-50 px-4 py-3">
              <div class="text-xs text-neutral-500">Sexe</div>
              <div id="patientGender" class="font-semibold text-neutral-800">—</div>
            </div>
            <div class="rounded-xl border border-neutral-200 bg-neutral-50 px-4 py-3">
              <div class="text-xs text-neutral-500">Date de naissance</div>
              <div id="patientDob" class="font-semibold text-neutral-800">—</div>
            </div>
          </div>

          <!-- Date d'examen -->
          <div class="mt-5">
            <label for="nsExamDate" class="block text-sm font-medium text-neutral-700 mb-2">Date d'examen</label>
            <input id="nsExamDate" type="date" class="w-full sm:w-auto rounded-xl border border-neutral-300 bg-white px-4 py-2 text-neutral-800 shadow-inner focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400" />
          </div>
        </div>
      </div>

      <!-- Upload (2) -->
      <div class="lg:col-span-2 space-y-6">
        <div class="rounded-2xl p-6 bg-white border border-neutral-200 shadow-sm">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-700 flex items-center justify-center">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h2 class="font-semibold text-neutral-900">Téléversement</h2>
          </div>

          <div id="nsDropZone" class="rounded-2xl border-2 border-dashed border-neutral-300 bg-neutral-50 hover:bg-neutral-100 transition p-10 text-center cursor-pointer">
            <div class="mx-auto w-16 h-16 rounded-full bg-neutral-200 text-neutral-600 flex items-center justify-center mb-4">
              <i class="fas fa-file-medical"></i>
            </div>
            <p class="font-semibold text-neutral-800">Déposez votre image IRM ici</p>
            <p class="text-sm text-neutral-500">ou cliquez pour parcourir • JPG, PNG, DICOM (max 50MB)</p>
            <input id="nsFileInput" type="file" class="hidden" accept=".jpg,.jpeg,.png,.dcm,.dicom,.nii">
          </div>

          <div id="nsFileInfo" class="hidden mt-5 rounded-xl bg-neutral-50 border border-neutral-200 p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-emerald-500 text-white flex items-center justify-center">
                  <i class="fas fa-check"></i>
                </div>
                <div>
                  <div id="nsFileName" class="font-semibold text-neutral-900"></div>
                  <div id="nsFileSize" class="text-sm text-neutral-500"></div>
                </div>
              </div>
              <div class="w-48 h-2 rounded-full bg-neutral-200 overflow-hidden">
                <div id="nsUploadProgress" class="h-2 bg-gradient-to-r from-emerald-500 to-teal-600" style="width:0%"></div>
              </div>
            </div>
          </div>

          <button id="nsAnalyzeBtn" class="mt-6 w-full rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-4 shadow-sm hover:shadow focus:outline-none focus:ring-4 focus:ring-blue-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Lancer l'analyse IA
          </button>
        </div>
      </div>

      <!-- Statut (1) -->
      <div class="lg:col-span-1 space-y-6">
        <div id="nsProgressCard" class="rounded-2xl p-6 bg-white border border-neutral-200 shadow-sm hidden">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-neutral-100 text-neutral-700 flex items-center justify-center">
              <i class="fas fa-cogs"></i>
            </div>
            <h2 class="font-semibold text-neutral-900">Analyse en cours</h2>
          </div>
          <div class="text-sm text-neutral-600 mb-2" id="nsStatusText">En attente du fichier...</div>
          <div class="w-full h-2 rounded-full bg-neutral-200 overflow-hidden">
            <div id="nsAnalysisProgress" class="h-2 bg-gradient-to-r from-blue-600 to-indigo-600" style="width:0%"></div>
          </div>
          <div class="mt-2 text-right text-sm font-semibold text-neutral-700" id="nsProgressPct">0%</div>
        </div>

        <div id="nsResultsCard" class="rounded-2xl p-6 bg-emerald-50 border border-emerald-200 text-emerald-800 shadow-sm hidden cursor-pointer hover:shadow-md transition" onclick="openResultsModal()">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-emerald-500 text-white flex items-center justify-center shrink-0">
              <i class="fas fa-check text-lg"></i>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <div class="font-semibold">Analyse terminée</div>
                <span id="nsResultMiniBadge" class="px-2 py-1 rounded-md bg-blue-600 text-white text-xs font-semibold">—</span>
              </div>
              <div id="nsResultMiniSummary" class="text-sm opacity-90 truncate">Cliquez pour voir le rapport détaillé</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Modal résultats -->
<div id="resultsModal" class="fixed inset-0 hidden items-start justify-center bg-black/50 overflow-y-hidden p-4 md:p-6" aria-modal="true" role="dialog">
  <div class="modal-content w-full mx-0 md:mx-4 rounded-2xl shadow-2xl bg-white" style="width: min(80vw, 1200px);" onclick="event.stopPropagation()">
    <div class="p-6 border-b border-neutral-200 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-emerald-50 text-emerald-700 flex items-center justify-center">
          <i class="fas fa-file-medical"></i>
        </div>
        <div>
          <div class="text-xl font-bold text-neutral-900">Rapport de Diagnostic IA</div>
          <div class="text-sm text-neutral-500">Généré automatiquement • <span id="modalAnalysisId" class="font-medium text-neutral-700"></span></div>
        </div>
      </div>
      <button id="closeModal" class="rounded-lg px-3 py-2 text-neutral-600 hover:bg-neutral-100">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="p-6 overflow-y-auto max-h-[80vh]">
      <!-- En-tête patient -->
      <div class="rounded-xl border border-neutral-200 p-4 mb-6 bg-neutral-50">
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <div class="flex items-center gap-2 px-3 py-1 rounded-lg bg-white border border-neutral-200"><i class="fas fa-user text-neutral-600"></i><span id="hdrPatientName" class="font-semibold text-neutral-900">—</span></div>
          <div class="flex items-center gap-2 px-3 py-1 rounded-lg bg-white border border-neutral-200"><i class="fas fa-birthday-cake text-neutral-600"></i><span id="hdrPatientAge">—</span></div>
          <div class="flex items-center gap-2 px-3 py-1 rounded-lg bg-white border border-neutral-200"><i class="fas fa-venus-mars text-neutral-600"></i><span id="hdrPatientGender">—</span></div>
          <div class="flex items-center gap-2 px-3 py-1 rounded-lg bg-white border border-neutral-200"><i class="fas fa-calendar-day text-neutral-600"></i><span id="hdrExamDate">—</span></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Image IRM -->
        <div class="lg:col-span-5">
          <div class="rounded-xl border border-neutral-200 overflow-hidden bg-black/5 flex items-center justify-center">
            <img id="modalResultImg" class="w-full h-96 object-contain" alt="IRM" />
          </div>
        </div>
        <!-- Informations diagnostic -->
        <div class="lg:col-span-7 space-y-4">
          <div class="flex flex-wrap items-center gap-3">
            <span id="modalDiagBadge" class="px-3 py-1 rounded-lg bg-blue-600 text-white text-sm font-semibold">—</span>
            <div class="text-sm text-neutral-500">Temps d'analyse: <span id="modalProcTime" class="font-semibold text-neutral-800">—</span></div>
          </div>
          <div id="modalPrediction" class="text-3xl font-bold text-neutral-900">—</div>
          <!-- Confiance visuelle -->
          <div>
            <div class="flex items-center justify-between text-sm text-neutral-600 mb-1">
              <span>Niveau de confiance</span>
              <span id="modalConfidence" class="font-semibold text-neutral-900">—</span>
            </div>
            <div class="w-full h-3 rounded-full bg-neutral-200 overflow-hidden">
              <div id="modalConfidenceBar" class="h-3 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600" style="width:0%"></div>
            </div>
          </div>
          <!-- Résumé patient -->
          <div id="modalPatientSummary" class="text-neutral-700">—</div>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-6">
        <div class="rounded-xl border border-neutral-200 p-4">
          <div class="font-semibold text-neutral-900 mb-3">Scores et Répartition</div>
          <div class="relative h-80 mt-2">
            <canvas id="modalProbChart" class="absolute inset-0 w-full h-full"></canvas>
          </div>
          <div id="modalProbs" class="mt-4 space-y-2"></div>
        </div>
        <div class="rounded-xl border border-neutral-200 p-4">
          <div class="font-semibold text-neutral-900 mb-3">Recommandations</div>
          <ul id="modalRecs" class="space-y-2 text-neutral-700 text-sm"></ul>
        </div>
        <!-- Analyse IA Avancée (Gemini) -->
        <div class="rounded-xl border border-neutral-200 p-4 xl:col-span-1">
          <div class="font-semibold text-neutral-900 mb-3 flex items-center"><i class="fas fa-microscope text-purple-600 mr-2"></i>Analyse IA Avancée</div>
          <div id="advLoading" class="text-sm text-neutral-500">Analyse en cours…</div>
          <div id="advContent" class="hidden space-y-3">
            <div class="flex items-start gap-3">
              <i class="fas fa-stethoscope text-emerald-600 mt-1"></i>
              <div>
                <div class="text-sm font-semibold text-neutral-800">Résumé clinique</div>
                <div id="advSummary" class="text-sm text-neutral-700">—</div>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <i class="fas fa-brain text-blue-600 mt-1"></i>
              <div>
                <div class="text-sm font-semibold text-neutral-800">Explication du diagnostic</div>
                <div id="advExplanation" class="text-sm text-neutral-700">—</div>
              </div>
            </div>
            <div>
              <div class="text-sm font-semibold text-neutral-800 mb-1 flex items-center"><i class="fas fa-notes-medical text-amber-600 mr-2"></i>Suggestions de suivi</div>
              <ul id="advSuggestions" class="space-y-1 text-sm text-neutral-700"></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap items-center justify-end gap-3 mt-6">
        <button class="rounded-xl px-4 py-2 bg-neutral-100 text-neutral-800 hover:bg-neutral-200">Historique</button>
        <button id="shareBtn" class="rounded-xl px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700">Partager</button>
        <button id="reportBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white hover:bg-blue-700">Télécharger PDF</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let analysisResults = null;

function openResultsModal() {
  if (!analysisResults) return;
  document.getElementById('modalResultImg').src = analysisResults.imageUrl || '';
  document.getElementById('modalPrediction').textContent = analysisResults.prediction || '—';
  const badge = document.getElementById('modalDiagBadge');
  badge.textContent = analysisResults.diagnosis || '—';
  badge.className = `px-3 py-1 rounded-lg text-white text-sm font-semibold ${analysisResults.badgeClass || 'bg-blue-600'}`;
  document.getElementById('modalConfidence').textContent = analysisResults.confidence || '—';
  document.getElementById('modalProcTime').textContent = analysisResults.processingTime || '—';
  document.getElementById('modalPatientSummary').textContent = analysisResults.patientSummary || '—';
  const idEl = document.getElementById('modalAnalysisId');
  if (idEl) idEl.textContent = analysisResults.id || '';
  // Header patient chips
  const hdrName = document.getElementById('hdrPatientName');
  const hdrAge = document.getElementById('hdrPatientAge');
  const hdrGender = document.getElementById('hdrPatientGender');
  const hdrExam = document.getElementById('hdrExamDate');
  if (hdrName) hdrName.textContent = analysisResults.patientName || '—';
  if (hdrAge) hdrAge.textContent = analysisResults.patientAge || '—';
  if (hdrGender) hdrGender.textContent = analysisResults.patientGender || '—';
  if (hdrExam) hdrExam.textContent = analysisResults.examDate || '—';

  // Confiance bar width
  const confVal = (typeof analysisResults.confidence === 'string') ? parseFloat(analysisResults.confidence.replace('%','')) : (analysisResults.confidence || 0);
  const bar = document.getElementById('modalConfidenceBar');
  if (bar) bar.style.width = `${Math.max(0, Math.min(100, confVal))}%`;

  if (analysisResults.chartData) createModalChart(analysisResults.chartData);
  if (analysisResults.probabilities) fillModalProbabilities(analysisResults.probabilities);
  if (analysisResults.recommendations) fillModalRecommendations(analysisResults.recommendations);

  // Analyse avancée (Gemini)
  fetchAdvancedAnalysis(analysisResults).catch(()=>{});

  const modal = document.getElementById('resultsModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  // Lock page scroll when modal is open
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
}

function closeResultsModal() {
  const modal = document.getElementById('resultsModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  // Restore page scroll
  document.documentElement.style.overflow = '';
  document.body.style.overflow = '';
}

document.addEventListener('click', (e) => {
  if (e.target.id === 'closeModal' || e.target.id === 'resultsModal') closeResultsModal();
});

function createModalChart(data) {
  const canvas = document.getElementById('modalProbChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  if (window._modalChart) window._modalChart.destroy();
  window._modalChart = new Chart(ctx, {
    type: 'doughnut',
    data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      layout: { padding: 0 },
    }
  });
}

function fillModalProbabilities(list) {
  const c = document.getElementById('modalProbs');
  c.innerHTML = '';
  const palette = ['#2563eb','#7c3aed','#059669','#d97706','#dc2626','#14b8a6','#f59e0b'];
  list.forEach((p, i) => {
    const color = palette[i % palette.length];
    const row = document.createElement('div');
    row.className = 'space-y-1';
    row.innerHTML = `
      <div class="flex items-center justify-between text-sm">
        <span class="text-neutral-700">${p.name}</span>
        <span class="font-semibold text-neutral-900">${p.value}%</span>
      </div>
      <div class="w-full h-2 bg-neutral-200 rounded-full overflow-hidden">
        <div class="h-2 rounded-full" style="width:${p.value}%; background:${color}"></div>
      </div>`;
    c.appendChild(row);
  });
}

function fillModalRecommendations(recs) {
  const ul = document.getElementById('modalRecs');
  ul.innerHTML = '';
  const icons = ['fa-user-md text-emerald-600','fa-eye text-blue-600','fa-hospital text-purple-600','fa-vial text-amber-600'];
  recs.forEach((r,i) => {
    const li = document.createElement('li');
    li.className = 'flex items-start gap-2';
    li.innerHTML = `<i class="fas ${icons[i%icons.length]} mt-1"></i><span>${r}</span>`;
    ul.appendChild(li);
  });
}

function getBadgeClass(pred) {
  // Couleurs distinctes par type: Méningiome violet, Gliome orange, Normal vert, Tumeur hypophysaire bleu
  const map = {
    'Normal': 'bg-emerald-600',
    'Gliome': 'bg-orange-600',
    'Méningiome': 'bg-purple-600',
    'Tumeur pituitaire': 'bg-blue-600'
  };
  return map[pred] || 'bg-blue-600';
}

// --- Normalisation & formatage des pourcentages ---
function normalizePercent(value) {
  if (value == null) return null;
  let n = (typeof value === 'string') ? parseFloat(value.replace('%', '').trim()) : Number(value);
  if (Number.isNaN(n)) return null;
  // Beaucoup d'API renvoient des ratios 0–1. Si c'est le cas, convertir en %.
  if (n > 0 && n <= 1) n = n * 100;
  // Clamp sécurité
  if (n < 0) n = 0; if (n > 100) n = 100;
  return n;
}

function formatPercent(value, decimals = 1) {
  const n = normalizePercent(value);
  return (n == null) ? '—' : `${n.toFixed(decimals)}%`;
}

function createChartData(prob) {
  const labels = Object.keys(prob);
  const data = Object.values(prob).map(v => normalizePercent(v) ?? 0);
  const colors = ['#2563eb','#7c3aed','#059669','#d97706','#dc2626'];
  return { labels, datasets: [{ data, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }] };
}

function createProbabilityList(prob) {
  return Object.entries(prob).map(([name, value]) => ({ name, value: (normalizePercent(value) ?? 0).toFixed(1) }));
}

// Page setup
(function initPage(){
  const select = document.getElementById('patientSelect');
  const info = document.getElementById('patientInfo');
  const analyzeBtn = document.getElementById('nsAnalyzeBtn');
  const drop = document.getElementById('nsDropZone');
  const input = document.getElementById('nsFileInput');
  const fileInfo = document.getElementById('nsFileInfo');
  const fileName = document.getElementById('nsFileName');
  const fileSize = document.getElementById('nsFileSize');
  const progressCard = document.getElementById('nsProgressCard');
  const progressBar = document.getElementById('nsAnalysisProgress');
  const progressPct = document.getElementById('nsProgressPct');
  const statusText = document.getElementById('nsStatusText');
  const resultsCard = document.getElementById('nsResultsCard');
  const reportBtn = document.getElementById('reportBtn');
  const shareBtn = document.getElementById('shareBtn');
  const examDateInput = document.getElementById('nsExamDate');

  // Set default exam date to today
  if (examDateInput) {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    examDateInput.value = `${yyyy}-${mm}-${dd}`;
  }

  function updateAnalyzeButton() {
    const ok = !!select.value && input.files.length > 0;
    analyzeBtn.disabled = !ok;
  }

  select.addEventListener('change', () => {
    const opt = select.options[select.selectedIndex];
    if (!opt.value) { info.classList.add('hidden'); updateAnalyzeButton(); return; }
    document.getElementById('patientName').textContent = opt.dataset.name;
    document.getElementById('patientAge').textContent = `${opt.dataset.age} ans`;
    document.getElementById('patientGender').textContent = opt.dataset.gender;
    document.getElementById('patientDob').textContent = opt.dataset.dob;
    info.classList.remove('hidden');
    updateAnalyzeButton();
  });

  // Auto-sélection depuis la liste patients
  try {
    const pre = sessionStorage.getItem('preselectedPatient');
    if (pre && select) {
      const opt = Array.from(select.options).find(o => o.value === pre);
      if (opt) {
        select.value = pre;
        document.getElementById('patientName').textContent = opt.dataset.name || '—';
        document.getElementById('patientAge').textContent = opt.dataset.age ? `${opt.dataset.age} ans` : '—';
        document.getElementById('patientGender').textContent = opt.dataset.gender || '—';
        document.getElementById('patientDob').textContent = opt.dataset.dob || '—';
        info.classList.remove('hidden');
        updateAnalyzeButton();
      }
      sessionStorage.removeItem('preselectedPatient');
    }
  } catch {}

  function formatSize(bytes){ if(bytes<1024) return bytes+' B'; const u=['KB','MB','GB']; let i=-1; do{bytes/=1024;i++;}while(bytes>=1024&&i<u.length-1); return bytes.toFixed(1)+' '+u[i]; }

  function onFileSelected(file){
    if (!file) return;
    const allowed = ['dcm','dicom','nii','jpg','jpeg','png'];
    const ext = file.name.split('.').pop().toLowerCase();
    if (!allowed.includes(ext)) { alert('Format non supporté'); return; }
    fileName.textContent = file.name;
    fileSize.textContent = formatSize(file.size);
    fileInfo.classList.remove('hidden');
    input.files = input.files;
    updateAnalyzeButton();
  }

  drop.addEventListener('click', () => input.click());
  input.addEventListener('change', (e) => onFileSelected(e.target.files[0]));
  drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('bg-neutral-100'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('bg-neutral-100'));
  drop.addEventListener('drop', (e) => { e.preventDefault(); const f = e.dataTransfer.files[0]; if(f){ input.files=e.dataTransfer.files; onFileSelected(f);} drop.classList.remove('bg-neutral-100'); });

  analyzeBtn.addEventListener('click', async () => {
    // Start progress
    resultsCard.classList.add('hidden');
    progressCard.classList.remove('hidden');
    statusText.textContent = 'Téléversement du fichier...';

  const formData = new FormData();
  formData.append('file', input.files[0]);
  formData.append('patient_id', select.value);
  const patientNameVal = document.getElementById('patientName').textContent || (select.options[select.selectedIndex]?.dataset?.name || '');
  if (patientNameVal) formData.append('patient_name', patientNameVal);
  if (examDateInput && examDateInput.value) formData.append('exam_date', examDateInput.value);

    // Upload with XHR for progress
    let uploadOk = false;
    let uploadResponseText = null;
    await new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = `${pct}%`;
          progressPct.textContent = `${pct}%`;
        }
      };
      xhr.onload = () => { uploadOk = xhr.status === 200; uploadResponseText = xhr.responseText; resolve(); };
      xhr.onerror = () => resolve();
      xhr.send(formData);
    });

  statusText.textContent = uploadOk ? 'Analyse IA en cours...' : 'Analyse locale (démo)';
    progressBar.style.width = '100%';
    progressPct.textContent = '100%';

    let resData;
    if (uploadOk && uploadResponseText) {
      try { resData = JSON.parse(uploadResponseText); } catch (e) { /* ignore parse error */ }
    }

  if (!resData) {
      // Fallback démo
      // En mode fallback (démo), rester sur la page actuelle et afficher la carte comme avant
      // Mais si vous souhaitez forcer une redirection même en démo, on peut générer un faux id côté client
      resData = {
        analysis_id: null,
        prediction: 'Normal',
        confidence: 97.4,
        processing_time: 8.2,
        probabilities: { 'Normal': 97.4, 'Gliome': 1.2, 'Méningiome': 0.8, 'Tumeur pituitaire': 0.6 },
        description: 'Absence de masse tumorale détectable.',
        image_url: ''
      };
    }

  // Redirection vers la page dédiée si un analysis_id est retourné
  if (resData && resData.analysis_id) {
    window.location.href = `/analysis/${resData.analysis_id}`;
    return;
  }

  // Fallback: conserver l'ancien affichage si aucun analysis_id (mode démo)
  analysisResults = {
    id: resData.analysis_id || 'DEMO',
    imageUrl: resData.image_url,
    prediction: resData.prediction,
    diagnosis: resData.prediction,
    badgeClass: getBadgeClass(resData.prediction),
    confidence: formatPercent(resData.confidence),
    processingTime: (typeof resData.processing_time === 'number' ? `${resData.processing_time.toFixed(1)}s` : `${resData.processing_time || ''}s`).trim(),
    patientName: document.getElementById('patientName').textContent || '—',
    patientAge: document.getElementById('patientAge').textContent || '—',
    patientGender: document.getElementById('patientGender').textContent || '—',
    examDate: document.getElementById('nsExamDate')?.value || '',
    patientSummary: `Patient: ${document.getElementById('patientName').textContent} • ${document.getElementById('patientAge').textContent} • ${document.getElementById('patientGender').textContent}`,
    chartData: createChartData(resData.probabilities),
    probabilities: createProbabilityList(resData.probabilities),
    recommendations: [
      'Corrélation clinique recommandée',
      'Surveillance radiologique si nécessaire',
      'Consulter un radiologue en cas de doute'
    ]
  };

  progressCard.classList.add('hidden');
  resultsCard.classList.remove('hidden');
  const miniBadge = document.getElementById('nsResultMiniBadge');
  if (miniBadge) { miniBadge.textContent = analysisResults.diagnosis; miniBadge.className = `px-2 py-1 rounded-md text-white text-xs font-semibold ${analysisResults.badgeClass || 'bg-blue-600'}`; }
  const miniSummary = document.getElementById('nsResultMiniSummary');
  if (miniSummary) miniSummary.textContent = `Diagnostic: ${analysisResults.diagnosis} • Confiance: ${analysisResults.confidence} • Temps: ${analysisResults.processingTime}`;
  });

  // Actions dans le modal
  if (reportBtn) {
    reportBtn.addEventListener('click', async () => {
      if (!analysisResults) return;
      try {
        const resp = await fetch('/generate-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patientName: document.getElementById('patientName').textContent, analysisData: analysisResults })
        });
        const data = await resp.json();
        alert(data.success ? 'Rapport généré' : 'Erreur génération rapport');
      } catch {
        alert('Erreur réseau');
      }
    });
  }
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      if (!analysisResults) return;
      const email = prompt('Email du destinataire:');
      if (!email) return;
      try {
        const resp = await fetch('/share-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipientEmail: email, analysisData: analysisResults })
        });
        const data = await resp.json();
        alert(data.success ? 'Analyse partagée' : 'Erreur partage');
      } catch {
        alert('Erreur réseau');
      }
    });
  }
})();

// Appel backend Gemini avancé
async function fetchAdvancedAnalysis(analysis) {
  try {
    const payload = {
      predicted_label: analysis.diagnosis,
      confidence: (typeof analysis.confidence === 'string') ? parseFloat(analysis.confidence.replace('%','')) : (analysis.confidence*100),
      probabilities: (analysis.chartData && analysis.chartData.labels) ? Object.fromEntries(analysis.chartData.labels.map((l,idx)=>[l, analysis.chartData.datasets[0].data[idx]/100])) : {}
    };
    const res = await fetch('/api/advanced-analysis', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const json = await res.json();
    const loading = document.getElementById('advLoading');
    const content = document.getElementById('advContent');
    if (!json.success) { if (loading) loading.textContent = "Indisponible pour le moment"; return; }
    if (loading) loading.classList.add('hidden');
    if (content) content.classList.remove('hidden');
    if (json.data) {
      if (json.data.summary) document.getElementById('advSummary').textContent = json.data.summary;
      if (json.data.explanation) document.getElementById('advExplanation').textContent = json.data.explanation;
      const ul = document.getElementById('advSuggestions');
      ul.innerHTML = '';
      (json.data.suggestions || []).forEach(s => { const li = document.createElement('li'); li.textContent = s; ul.appendChild(li); });
    }
  } catch (e) {
    const loading = document.getElementById('advLoading'); if (loading) loading.textContent = "Indisponible";
  }
}
</script>
{% endblock %}
