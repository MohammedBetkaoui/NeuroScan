{% extends "base_dashboard.html" %}

{% block title %}Tableau de Bord Pro - NeuroScan{% endblock %}

{% block page_subtitle %}Analyse & Statistiques{% endblock %}

{% block page_title %}Tableau de Bord Professionnel{% endblock %}

{% block page_description %}Analyses détaillées, statistiques avancées et tendances de vos diagnostics{% endblock %}

{% block extra_css %}
<style>
    /* Stat cards avec gradients modernes */
    .stat-card-gradient {
        position: relative;
        overflow: hidden;
        border-radius: var(--radius-xl);
        transition: var(--transition-normal);
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .stat-card-gradient::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        z-index: 1;
    }

    .stat-card-gradient > * {
        position: relative;
        z-index: 2;
    }

    .stat-card-gradient:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: var(--shadow-2xl);
    }

    .stat-card-gradient.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card-gradient.green {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .stat-card-gradient.purple {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card-gradient.orange {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    }

    /* Graphiques */
    .chart-container {
        position: relative;
        height: 300px;
        background: var(--surface-primary);
        border-radius: var(--radius-xl);
        padding: 24px;
        box-shadow: var(--shadow-medium);
        border: 1px solid rgba(229, 231, 235, 0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chart-container {
            height: 250px;
            padding: 16px;
        }
    }
</style>
{% endblock %}

{% block secondary_nav %}
<div class="dashboard-nav mb-8">
    <a href="{{ url_for('dashboard') }}" class="dashboard-nav-item">
        <i class="fas fa-home mr-2"></i>Accueil
    </a>
    <a href="{{ url_for('pro_dashboard') }}" class="dashboard-nav-item active">
        <i class="fas fa-chart-bar mr-2"></i>Statistiques
    </a>
    <a href="{{ url_for('patients_list') }}" class="dashboard-nav-item">
        <i class="fas fa-users mr-2"></i>Patients
    </a>
    <a href="{{ url_for('platform_stats') }}" class="dashboard-nav-item">
        <i class="fas fa-globe mr-2"></i>Plateforme
    </a>
</div>
{% endblock %}

{% block page_actions %}
<div class="flex space-x-3">
    <button onclick="exportData()" class="btn-dashboard secondary">
        <i class="fas fa-download"></i>
        Exporter
    </button>
    <button onclick="refreshData()" class="btn-dashboard primary" id="refreshBtn">
        <i class="fas fa-sync-alt"></i>
        Actualiser
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Statistiques rapides -->
<div class="stats-grid mb-8">
    <div class="stat-card-gradient blue p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-sm font-medium">Analyses Totales</p>
                <p class="text-3xl font-bold" id="totalAnalyses">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-brain text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-green-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="totalAnalysesChange">+0%</span>
            </span>
            <span class="text-blue-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>

    <div class="stat-card-gradient green p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-sm font-medium">Tumeurs Détectées</p>
                <p class="text-3xl font-bold" id="tumorsDetected">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-red-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="tumorsDetectedChange">+0%</span>
            </span>
            <span class="text-green-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>

    <div class="stat-card-gradient purple p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-purple-100 text-sm font-medium">Patients Suivis</p>
                <p class="text-3xl font-bold" id="patientsCount">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-yellow-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="patientsChange">+0%</span>
            </span>
            <span class="text-purple-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>

    <div class="stat-card-gradient orange p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-orange-100 text-sm font-medium">Précision Moyenne</p>
                <p class="text-3xl font-bold" id="avgConfidence">-</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-target text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <span class="text-yellow-200 text-sm">
                <i class="fas fa-arrow-up mr-1"></i>
                <span id="avgConfidenceChange">+0%</span>
            </span>
            <span class="text-orange-100 text-sm ml-2">vs mois dernier</span>
        </div>
    </div>
</div>

<!-- Graphiques principaux -->
<div class="dashboard-grid cols-2 mb-8">
    <!-- Graphique des analyses par période -->
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-6">
            <div class="dashboard-card-icon primary">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="flex-1">
                <h3 class="dashboard-card-title">Évolution des Analyses</h3>
                <p class="dashboard-card-subtitle">Analyses effectuées par période</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="changeTimeRange('7d')" class="btn-dashboard secondary text-xs" id="btn-7d">7j</button>
                <button onclick="changeTimeRange('30d')" class="btn-dashboard primary text-xs" id="btn-30d">30j</button>
                <button onclick="changeTimeRange('90d')" class="btn-dashboard secondary text-xs" id="btn-90d">90j</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="analysisChart"></canvas>
        </div>
    </div>

    <!-- Graphique de répartition des diagnostics -->
    <div class="dashboard-card p-6">
        <div class="dashboard-card-header mb-6">
            <div class="dashboard-card-icon success">
                <i class="fas fa-pie-chart"></i>
            </div>
            <div>
                <h3 class="dashboard-card-title">Répartition des Diagnostics</h3>
                <p class="dashboard-card-subtitle">Distribution par type de tumeur</p>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="diagnosticChart"></canvas>
        </div>
    </div>
</div>

<!-- Tableaux de données -->
<div class="dashboard-grid cols-1 mb-8">
    <!-- Analyses récentes -->
    <div class="dashboard-card p-0 overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="dashboard-card-header">
                <div class="dashboard-card-icon indigo">
                    <i class="fas fa-history"></i>
                </div>
                <div class="flex-1">
                    <h3 class="dashboard-card-title">Analyses Récentes</h3>
                    <p class="dashboard-card-subtitle">Dernières analyses effectuées</p>
                </div>
                <a href="{{ url_for('pro_dashboard_advanced') }}" class="btn-dashboard secondary">
                    <i class="fas fa-external-link-alt"></i>
                    Voir tout
                </a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Patient</th>
                        <th>Diagnostic</th>
                        <th>Confiance</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentAnalysesTable">
                    <!-- Données chargées dynamiquement -->
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="skeleton h-6 w-full mb-2"></div>
                            <div class="skeleton h-6 w-3/4 mx-auto"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Alertes et notifications -->
<div class="dashboard-grid cols-1">
    <div class="dashboard-card p-6 bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200">
        <div class="dashboard-card-header">
            <div class="dashboard-card-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="flex-1">
                <h3 class="dashboard-card-title text-amber-900">Alertes Médicales Actives</h3>
                <p class="dashboard-card-subtitle text-amber-700">Patients nécessitant votre attention</p>
            </div>
            <a href="{{ url_for('medical_alerts_page') }}" class="btn-dashboard warning">
                <i class="fas fa-eye"></i>
                Consulter
            </a>
        </div>
        <div class="dashboard-card-content">
            <div id="activeAlerts" class="space-y-3">
                <!-- Alertes chargées dynamiquement -->
                <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                    <div class="skeleton h-4 w-1/3"></div>
                    <div class="skeleton h-4 w-24"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Variables pour les graphiques
    let analysisChart;
    let diagnosticChart;
    let currentTimeRange = '30d';

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        loadStatistics();
        loadRecentAnalyses();
        loadActiveAlerts();
        
        // Actualisation automatique toutes les 5 minutes
        setInterval(refreshData, 300000);
    });

    // Initialisation des graphiques
    function initializeCharts() {
        // Graphique d'évolution des analyses
        const analysisCtx = document.getElementById('analysisChart').getContext('2d');
        analysisChart = new Chart(analysisCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Analyses',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });

        // Graphique de répartition des diagnostics
        const diagnosticCtx = document.getElementById('diagnosticChart').getContext('2d');
        diagnosticChart = new Chart(diagnosticCtx, {
            type: 'doughnut',
            data: {
                labels: ['Normal', 'Gliome', 'Méningiome', 'Tumeur pituitaire'],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(245, 158, 11, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    // Chargement des statistiques
    async function loadStatistics() {
        try {
            const response = await fetch('/api/analytics/overview');
            const data = await response.json();

            if (data.success) {
                updateStatistics(data.data);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des statistiques:', error);
        }
    }

    // Mise à jour des statistiques
    function updateStatistics(stats) {
        document.getElementById('totalAnalyses').textContent = stats.total_analyses || 0;
        document.getElementById('tumorsDetected').textContent = stats.tumors_detected || 0;
        document.getElementById('patientsCount').textContent = stats.patients_count || 0;
        document.getElementById('avgConfidence').textContent = (stats.avg_confidence * 100).toFixed(1) + '%' || '0%';

        // Mise à jour des changements (simulation)
        document.getElementById('totalAnalysesChange').textContent = '+' + (Math.random() * 20).toFixed(1) + '%';
        document.getElementById('tumorsDetectedChange').textContent = '+' + (Math.random() * 15).toFixed(1) + '%';
        document.getElementById('patientsChange').textContent = '+' + (Math.random() * 10).toFixed(1) + '%';
        document.getElementById('avgConfidenceChange').textContent = '+' + (Math.random() * 5).toFixed(1) + '%';

        // Mise à jour des graphiques
        updateCharts(stats);
    }

    // Mise à jour des graphiques
    function updateCharts(stats) {
        // Données d'exemple pour le graphique d'évolution
        const labels = [];
        const data = [];
        
        for (let i = 29; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }));
            data.push(Math.floor(Math.random() * 20) + 5);
        }

        analysisChart.data.labels = labels;
        analysisChart.data.datasets[0].data = data;
        analysisChart.update();

        // Données pour le graphique de répartition
        diagnosticChart.data.datasets[0].data = [
            stats.normal_count || 0,
            stats.glioma_count || 0,
            stats.meningioma_count || 0,
            stats.pituitary_count || 0
        ];
        diagnosticChart.update();
    }

    // Chargement des analyses récentes
    async function loadRecentAnalyses() {
        try {
            const response = await fetch('/api/analytics/recent');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                const tableBody = document.getElementById('recentAnalysesTable');
                tableBody.innerHTML = data.data.map(analysis => `
                    <tr class="hover:bg-gray-50 transition-colors duration-200">
                        <td class="font-medium">${formatDate(analysis.timestamp)}</td>
                        <td>${analysis.patient_name || 'Patient ' + analysis.patient_id}</td>
                        <td>
                            <span class="badge ${getBadgeClass(analysis.predicted_label)}">
                                ${analysis.predicted_label}
                            </span>
                        </td>
                        <td class="font-mono">${(analysis.confidence * 100).toFixed(1)}%</td>
                        <td>
                            <span class="badge ${analysis.confidence > 0.9 ? 'success' : analysis.confidence > 0.7 ? 'warning' : 'danger'}">
                                ${analysis.confidence > 0.9 ? 'Fiable' : analysis.confidence > 0.7 ? 'Modéré' : 'Incertain'}
                            </span>
                        </td>
                        <td>
                            <button onclick="viewAnalysis(${analysis.id})" class="btn-dashboard secondary text-xs">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('recentAnalysesTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
                            <p>Aucune analyse récente</p>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erreur lors du chargement des analyses récentes:', error);
        }
    }

    // Chargement des alertes actives
    async function loadActiveAlerts() {
        try {
            const response = await fetch('/api/alerts');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                const alertsContainer = document.getElementById('activeAlerts');
                alertsContainer.innerHTML = data.data.slice(0, 3).map(alert => `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-amber-200">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-${getSeverityIcon(alert.severity)} text-${getSeverityColor(alert.severity)}"></i>
                            <div>
                                <p class="font-medium text-gray-900 text-sm">${alert.title}</p>
                                <p class="text-gray-600 text-xs">${alert.patient_name} - ${formatDate(alert.created_at)}</p>
                            </div>
                        </div>
                        <button onclick="viewAlert(${alert.id})" class="btn-dashboard secondary text-xs">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `).join('');
            } else {
                document.getElementById('activeAlerts').innerHTML = `
                    <div class="text-center py-8 text-amber-700">
                        <i class="fas fa-check-circle text-4xl mb-4"></i>
                        <p>Aucune alerte active</p>
                        <p class="text-sm">Tous vos patients sont sous surveillance normale</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Erreur lors du chargement des alertes:', error);
        }
    }

    // Fonctions utilitaires
    function getBadgeClass(label) {
        switch (label) {
            case 'Normal': return 'success';
            case 'Gliome': return 'danger';
            case 'Méningiome': return 'info';
            case 'Tumeur pituitaire': return 'warning';
            default: return 'secondary';
        }
    }

    function getSeverityIcon(severity) {
        switch (severity) {
            case 'high': return 'exclamation-triangle';
            case 'medium': return 'exclamation-circle';
            case 'low': return 'info-circle';
            default: return 'bell';
        }
    }

    function getSeverityColor(severity) {
        switch (severity) {
            case 'high': return 'red-500';
            case 'medium': return 'amber-500';
            case 'low': return 'blue-500';
            default: return 'gray-500';
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Actions
    function changeTimeRange(range) {
        currentTimeRange = range;
        
        // Mise à jour des boutons
        document.querySelectorAll('[id^="btn-"]').forEach(btn => {
            btn.className = 'btn-dashboard secondary text-xs';
        });
        document.getElementById('btn-' + range).className = 'btn-dashboard primary text-xs';
        
        // Recharger les données
        loadStatistics();
    }

    function refreshData() {
        const refreshBtn = document.getElementById('refreshBtn');
        const icon = refreshBtn.querySelector('i');
        
        // Animation de rotation
        icon.classList.add('animate-spin');
        
        // Recharger toutes les données
        Promise.all([
            loadStatistics(),
            loadRecentAnalyses(),
            loadActiveAlerts()
        ]).finally(() => {
            icon.classList.remove('animate-spin');
            showNotification('Données actualisées', 'success');
        });
    }

    function exportData() {
        // Simulation d'export
        showNotification('Export en cours...', 'info');
        
        setTimeout(() => {
            const dataUrl = 'data:text/csv;charset=utf-8,Date,Analyses,Diagnostics\n' +
                           '2024-01-01,25,Normal\n' +
                           '2024-01-02,18,Gliome\n' +
                           '2024-01-03,32,Méningiome';
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUrl);
            link.setAttribute('download', 'neuroscan_stats_' + new Date().toISOString().split('T')[0] + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Export terminé', 'success');
        }, 2000);
    }

    function viewAnalysis(id) {
        showNotification('Redirection vers l\'analyse...', 'info');
        // Implémenter la redirection vers les détails de l'analyse
    }

    function viewAlert(id) {
        window.location.href = '/medical-alerts#alert-' + id;
    }
</script>
{% endblock %}
