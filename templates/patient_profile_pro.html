{% extends "base_dashboard.html" %}

{% block title %}Profil Patient | NeuroScan PRO{% endblock %}
{% block page_subtitle %}Espace Pro{% endblock %}
{% block page_title %}Profil de {{ patient.patient_name }}{% endblock %}
{% block page_description %}Vue unifiée et professionnelle du patient{% endblock %}

{% block extra_css %}
<style>
  .pro-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
  @media (min-width: 1024px) { .pro-grid { grid-template-columns: 300px minmax(0,1fr); } }
  @media (min-width: 1280px) { .pro-grid { grid-template-columns: 280px minmax(0,1fr); } }
  /* Expanded mode: hide left column items and use full-width right column */
  .pro-grid.expanded { grid-template-columns: 1fr; }
  .pro-grid.expanded > *:nth-child(odd) { display: none; }
  .pro-card { background: #fff; border-radius: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.06); border: 1px solid #eef2f7; }
  .pro-card .hd { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display:flex; align-items:center; gap:10px; }
  .pro-card .bd { padding: 16px 20px; }
  .avatar { width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg,#93c5fd,#3b82f6); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size: 24px; }
  .kpi { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:12px; }
  .kpi .item { background: #0f172a; color:#fff; border-radius: 12px; padding: 14px; }
  .kpi .val { font-size: 22px; font-weight: 800; }
  .badge { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight:600; border:1px solid #e2e8f0; background:#f8fafc; color:#0f172a; }
  .badge.low { background:#f8fafc; color:#0f172a; }
  .badge.mod { background:#f8fafc; color:#334155; }
  .badge.high { background:#f8fafc; color:#0f172a; }
  .chip { background:#f1f5f9; color:#0f172a; padding:4px 10px; border-radius:999px; font-size:12px; }
  .tab { display:flex; gap:8px; }
  .tab button { padding:8px 12px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-weight:600; }
  .tab button.active { background:#0ea5e9; border-color:#0ea5e9; color:#fff; }
  .table { width:100%; border-collapse:separate; border-spacing:0 8px; }
  .table th { text-align:left; padding:8px 10px; color:#64748b; font-size:12px; text-transform:uppercase; letter-spacing:.04em; cursor:pointer; }
  .table td { background:#fff; padding:12px 10px; border-top:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0; }
  .table tr td:first-child { border-left:1px solid #e2e8f0; border-top-left-radius:12px; border-bottom-left-radius:12px; }
  .table tr td:last-child { border-right:1px solid #e2e8f0; border-top-right-radius:12px; border-bottom-right-radius:12px; }
  .spark { height: 60px; }
  .actions { display:flex; gap:10px; }
  .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #e2e8f0; background:#fff; font-weight:600; }
  .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
  .btn.ghost { background:#fff; }
  .grid-2 { display: grid; gap: 16px; grid-template-columns: 1fr; }
  @media (min-width: 1024px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
  .list { display:grid; gap:10px; }
  .note { background:#f8fafc; border:1px dashed #cbd5e1; border-radius:12px; padding:12px; }
  canvas { max-width: 100%; }
  .filters { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
  .input, .select { border:1px solid #e2e8f0; border-radius:10px; padding:8px 10px; }
  .modal { position: fixed; inset:0; background: rgba(15, 23, 42, .55); display:none; align-items:center; justify-content:center; z-index: 50; }
  .modal.open { display:flex; }
  .modal .panel { background:#fff; border-radius:16px; width:min(920px, 96vw); max-height: 86vh; overflow:auto; box-shadow: 0 20px 40px rgba(0,0,0,.25); }
  .modal .panel .hd { position:sticky; top:0; background:#fff; z-index:1; }
  .severity { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #e2e8f0; color:#0f172a; background:#f8fafc; }
  /* Enhanced vertical stack styling */
  .space-y-4 { display: flex; flex-direction: column; }
  .space-y-4 > * + * { margin-top: 20px; position: relative; }
  .space-y-4 > * + *::before {
    content: "";
    position: absolute;
    top: -10px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, rgba(226,232,240,0) 0%, rgba(226,232,240,1) 20%, rgba(226,232,240,1) 80%, rgba(226,232,240,0) 100%);
    pointer-events: none;
  }
  @media (min-width: 1024px) {
    .space-y-4 > * + * { margin-top: 22px; }
  }
  .view-toggle { margin-bottom: 12px; display:flex; gap:8px; justify-content:flex-end; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#f1f5f9; color:#0f172a; font-size:12px; border:1px solid #e2e8f0; }
  .progress { height:8px; background:#f1f5f9; border-radius:999px; overflow:hidden; border:1px solid #e2e8f0; }
  .progress > span { display:block; height:100%; background:#2563eb; }
  .analysis-cards { display:grid; gap:12px; grid-template-columns: 1fr; }
  @media (min-width: 768px) { .analysis-cards { grid-template-columns: repeat(2, 1fr); } }
  @media (min-width: 1280px) { .analysis-cards { grid-template-columns: repeat(3, 1fr); } }
  .analysis-card { border:1px solid #e2e8f0; border-radius:12px; padding:12px; background:#fff; display:flex; flex-direction:column; gap:8px; }
  .analysis-card .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .muted { color:#64748b; font-size:12px; }
</style>
{% endblock %}

{% block page_actions %}
<div class="actions">
  <button class="btn ghost" id="btn-export"><i class="fas fa-download"></i>Exporter</button>
  <a class="btn ghost" href="{{ url_for('manage_patients_page') }}"><i class="fas fa-list"></i>Mes patients</a>
  <a class="btn" href="{{ url_for('edit_patient_page', patient_id=patient.patient_id) }}"><i class="fas fa-pen"></i>Modifier</a>
  <button class="btn primary" id="btn-new-analysis"><i class="fas fa-plus"></i>Nouvelle analyse</button>
  <button class="btn ghost" id="toggleExpand"><i class="fas fa-arrows-left-right-to-line"></i> Étendre</button>
</div>
{% endblock %}

{% block content %}
<div class="pro-grid">
  <!-- Colonne gauche: Patient card -->
  <div class="pro-card">
    <div class="hd">
      <div class="avatar">{{ patient.patient_name[:2] if patient.patient_name else 'PT' }}</div>
      <div>
        <div class="text-xl font-bold text-gray-900">{{ patient.patient_name }}</div>
        <div class="text-gray-500 text-sm">ID: {{ patient.patient_id }}</div>
      </div>
      <div class="ml-auto">
        <span class="badge {{ 'low' if patient.risk_level == 'Faible' else 'mod' if patient.risk_level == 'Modéré' else 'high' }}">
          <i class="fas fa-shield-heart"></i> Risque: {{ patient.risk_level or 'N/A' }}
        </span>
      </div>
    </div>
    <div class="bd">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="text-xs text-gray-500">Naissance</div>
          <div class="font-semibold">{{ patient.date_of_birth.strftime('%d/%m/%Y') if patient.date_of_birth else '—' }} <span class="text-gray-500" id="ageValue"></span></div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Sexe</div>
          <div class="font-semibold">{{ patient.gender or '—' }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Téléphone</div>
          <div class="font-semibold">{{ patient.phone or '—' }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Email</div>
          <div class="font-semibold">{{ patient.email or '—' }}</div>
        </div>
      </div>
      <hr class="my-4">
      <div class="grid grid-cols-3 gap-3">
        <div class="note">
          <div class="text-xs text-gray-500">1ère analyse</div>
          <div class="font-semibold">{{ patient.first_analysis_date.strftime('%d/%m/%Y') if patient.first_analysis_date else '—' }}</div>
        </div>
        <div class="note">
          <div class="text-xs text-gray-500">Dernière analyse</div>
          <div class="font-semibold">{{ patient.last_analysis_date.strftime('%d/%m/%Y') if patient.last_analysis_date else '—' }}</div>
        </div>
        <div class="note">
          <div class="text-xs text-gray-500">Total</div>
          <div class="font-semibold">{{ patient.total_analyses or analyses|length }}</div>
        </div>
      </div>
      <hr class="my-4">
      <div class="grid grid-cols-1 gap-3">
        <div>
          <div class="text-xs text-gray-500">Adresse</div>
          <div class="font-semibold">{{ patient.address or '—' }}</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="text-xs text-gray-500">Contact d'urgence</div>
            <div class="font-semibold">{{ patient.emergency_contact_name or '—' }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Téléphone (urgence)</div>
            <div class="font-semibold">{{ patient.emergency_contact_phone or '—' }}</div>
          </div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Numéro d'assurance</div>
          <div class="font-semibold">{{ patient.insurance_number or '—' }}</div>
        </div>
      </div>
    </div>
  </div>

  {% if alerts and alerts|length > 0 %}
  <div class="pro-card">
    <div class="hd"><i class="fas fa-bell"></i><b>Alertes médicales</b></div>
    <div class="bd list">
      {% for al in alerts[:5] %}
        <div class="flex items-start gap-3">
          <span class="severity"><i class="fas fa-circle-exclamation"></i>{{ al.severity|capitalize }}</span>
          <div>
            <div class="font-semibold">{{ al.title }}</div>
            <div class="text-gray-600 text-sm">{{ al.message }}</div>
            <div class="text-gray-400 text-xs mt-1">{{ al.created_at }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Colonne droite: contenu -->
  <div class="space-y-4">
    <!-- KPIs -->
    <div class="kpi">
      <div class="item">
        <div class="text-xs opacity-70">Analyses</div>
        <div class="val">{{ analyses|length }}</div>
      </div>
      <div class="item">
        <div class="text-xs opacity-70">Normal</div>
        <div class="val">{{ normal_count }}</div>
      </div>
      <div class="item">
        <div class="text-xs opacity-70">Anormal</div>
        <div class="val">{{ abnormal_count }}</div>
      </div>
      <div class="item">
        <div class="text-xs opacity-70">Confiance moy.</div>
        <div class="val">{{ ('%.1f' % (analyses|map(attribute='confidence')|sum / (analyses|length if analyses|length>0 else 1) * 100)) if analyses|length>0 else '—' }}%</div>
      </div>
    </div>

    <!-- Onglets -->
    <div class="pro-card">
      <div class="hd">
        <div class="tab">
          <button class="active" data-tab="evolution">Evolution</button>
          <button data-tab="analyses">Analyses</button>
          <button data-tab="notes">Notes</button>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <span class="chip">Dernière mise à jour: {{ current_date.strftime('%d/%m/%Y') }}</span>
        </div>
      </div>
      <div class="bd">
        <div id="tab-evolution">
          <canvas id="evolutionChart" height="120"></canvas>
        </div>
        <div id="tab-analyses" class="hidden">
          <div class="view-toggle">
            <span class="pill">Vue:</span>
            <button id="viewTable" class="btn ghost"><i class="fas fa-table"></i> Tableau</button>
            <button id="viewCards" class="btn ghost"><i class="fas fa-grip"></i> Cartes</button>
          </div>
          <div class="filters">
            <select id="f-diagnosis" class="select">
              <option value="">Tous les diagnostics</option>
              <option>Normal</option>
              <option>Gliome</option>
              <option>Méningiome</option>
              <option>Tumeur pituitaire</option>
            </select>
            <label class="flex items-center gap-2 text-sm text-gray-600">Min confiance
              <input id="f-minconf" class="input" type="number" min="0" max="100" step="1" value="0" style="width:90px">
              %
            </label>
            <input id="f-date" class="input" type="date">
            <input id="f-search" class="input" type="text" placeholder="Rechercher…">
            <button id="f-reset" class="btn ghost"><i class="fas fa-rotate"></i> Réinitialiser</button>
          </div>
          <table class="table" id="analysesTable">
            <thead>
              <tr>
                <th data-sort="date">Date</th>
                <th data-sort="label">Diagnostic</th>
                <th data-sort="confidence">Confiance</th>
                <th>Image</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for a in analyses %}
              <tr>
                <td>{{ a.exam_date or a.date_uploaded.strftime('%Y-%m-%d') }}</td>
                <td>{{ a.predicted_label }}</td>
                <td>{{ '%.1f' % (a.confidence*100) }}%</td>
                <td><a class="text-blue-600 hover:underline" href="{{ a.image_path }}" target="_blank">Voir</a></td>
                <td>
                  <div class="flex gap-2">
                    <button class="btn ghost open-modal"
                      data-id="{{ a.id }}"
                      data-date="{{ a.exam_date or a.date_uploaded.strftime('%Y-%m-%d') }}"
                      data-label="{{ a.predicted_label }}"
                      data-confidence="{{ '%.1f' % (a.confidence*100) }}"
                      data-img="{{ a.image_path }}"
                      data-desc="{{ (a.description or '')|e }}">
                      <i class="fas fa-eye"></i>
                    </button>
                    <a class="btn" href="{{ url_for('analysis_detail', analysis_id=a.id) }}" title="Détails"><i class="fas fa-arrow-right"></i></a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
      <div id="analysesCards" class="analysis-cards" style="display:none">
            {% for a in analyses %}
            <div class="analysis-card" data-date="{{ a.exam_date or a.date_uploaded.strftime('%Y-%m-%d') }}" data-label="{{ a.predicted_label }}" data-confidence="{{ '%.1f' % (a.confidence*100) }}">
              <div class="row">
                <div class="pill">{{ a.predicted_label }}</div>
                <div class="muted">{{ a.exam_date or a.date_uploaded.strftime('%Y-%m-%d') }}</div>
              </div>
              <div>
                <div class="muted">Confiance</div>
        <div class="progress"><span data-width="{{ '%.0f' % (a.confidence*100) }}"></span></div>
              </div>
              <div class="row">
                <a class="btn ghost open-modal"
                   data-id="{{ a.id }}"
                   data-date="{{ a.exam_date or a.date_uploaded.strftime('%Y-%m-%d') }}"
                   data-label="{{ a.predicted_label }}"
                   data-confidence="{{ '%.1f' % (a.confidence*100) }}"
                   data-img="{{ a.image_path }}"
                   data-desc="{{ (a.description or '')|e }}">
                   <i class="fas fa-eye"></i> Aperçu
                </a>
                <a class="btn" href="{{ url_for('analysis_detail', analysis_id=a.id) }}"><i class="fas fa-arrow-right"></i> Détails</a>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <div id="tab-notes" class="hidden">
          <div class="grid-2">
            <div class="pro-card">
              <div class="hd"><i class="fas fa-clipboard-list"></i><b>Recommandations</b></div>
              <div class="bd list">
                {% set latest = analyses[0] if analyses|length>0 else none %}
                {% for r in (latest.recommendations if latest and latest.recommendations else []) %}
                <div class="note">
                  <i class="fas fa-check-circle text-green-600"></i>
                  <span>{{ r }}</span>
                </div>
                {% else %}
                <div class="text-gray-500">Aucune recommandation disponible.</div>
                {% endfor %}
              </div>
            </div>
            <div class="pro-card">
              <div class="hd"><i class="fas fa-notes-medical"></i><b>Notes médicales</b></div>
              <div class="bd">
                <p class="text-gray-700">{{ latest.description if latest and latest.description else '—' }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Données pour JS -->
<script id="analyses-data" type="application/json">{{ analyses_json|safe }}</script>
<div class="modal" id="analysisModal" aria-hidden="true">
  <div class="panel pro-card">
    <div class="hd flex items-center justify-between">
      <div class="flex items-center gap-2"><i class="fas fa-file-medical"></i><b>Analyse</b></div>
      <button class="btn ghost" id="modalClose"><i class="fas fa-xmark"></i>Fermer</button>
    </div>
    <div class="bd grid-2">
      <div>
        <img id="mImage" src="" alt="IRM" style="width:100%; border-radius:12px; border:1px solid #e2e8f0;" />
      </div>
      <div class="space-y-3">
        <div><span class="chip">Date</span> <b id="mDate">—</b></div>
        <div><span class="chip">Diagnostic</span> <b id="mLabel">—</b></div>
        <div><span class="chip">Confiance</span> <b id="mConf">—</b></div>
        <div>
          <div class="text-xs text-gray-500">Notes médicales</div>
          <div id="mDesc" class="text-gray-700">—</div>
        </div>
      </div>
    </div>
  </div>
  <div class="sr-only" aria-live="polite">Fenêtre modale ouverte</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const tabs = document.querySelectorAll('.tab button');
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-evolution').classList.toggle('hidden', btn.dataset.tab !== 'evolution');
    document.getElementById('tab-analyses').classList.toggle('hidden', btn.dataset.tab !== 'analyses');
    document.getElementById('tab-notes').classList.toggle('hidden', btn.dataset.tab !== 'notes');
  }));

  const raw = document.getElementById('analyses-data')?.textContent || '[]';
  let data = [];
  try { data = JSON.parse(raw); } catch(e) { data = []; }
  
  const ctx = document.getElementById('evolutionChart');
  if (ctx && window.Chart) {
    const labels = data.map(d => new Date(d.date_uploaded).toLocaleDateString('fr-FR'));
    const series = data.map(d => Math.round(d.confidence * 1000) / 10);
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{
        label: 'Confiance (%)',
        data: series,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,.15)',
        tension: .35, fill: true, pointRadius: 3
      }]},
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, suggestedMax: 100 } }
      }
    });
  }

  document.getElementById('btn-export')?.addEventListener('click', () => {
    const exportData = {
      patient: {
        id: '{{ patient.patient_id }}',
        name: '{{ patient.patient_name }}',
        risk: '{{ patient.risk_level }}'
      },
      analyses: data
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `rapport_{{ patient.patient_id }}.json`; a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btn-new-analysis')?.addEventListener('click', () => {
    window.location.href = "{{ url_for('new_analysis_page') }}?patient_id={{ patient.patient_id }}";
  });

  // Calcul d'âge
  (function(){
    const span = document.getElementById('ageValue');
  const dobStr = "{{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else '' }}";
    if (!span || !dobStr) return;
    const dob = new Date(dobStr);
    if (isNaN(dob.getTime())) return;
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    span.textContent = `(${age} ans)`;
  })();

  // Filtres
  const table = document.getElementById('analysesTable');
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  const cardsWrap = document.getElementById('analysesCards');
  const cards = Array.from(cardsWrap.querySelectorAll('.analysis-card'));
  const fDiag = document.getElementById('f-diagnosis');
  const fMin = document.getElementById('f-minconf');
  const fDate = document.getElementById('f-date');
  const fSearch = document.getElementById('f-search');
  const fReset = document.getElementById('f-reset');
  function applyFilters(){
    const diag = (fDiag.value || '').toLowerCase();
    const minc = parseFloat(fMin.value || '0');
    const datef = fDate.value || '';
    const q = (fSearch.value || '').toLowerCase();
    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      const date = (tds[0]?.textContent || '').trim();
      const label = (tds[1]?.textContent || '').trim().toLowerCase();
      const conf = parseFloat(((tds[2]?.textContent || '0').replace('%','')).trim()) || 0;
      let ok = true;
      if (diag && label !== diag) ok = false;
      if (conf < minc) ok = false;
      if (datef && date !== datef) ok = false;
      if (q && !(date+label).includes(q)) ok = false;
      tr.style.display = ok ? '' : 'none';
    });
    cards.forEach(card => {
      const date = (card.dataset.date || '').trim();
      const label = (card.dataset.label || '').trim().toLowerCase();
      const conf = parseFloat(card.dataset.confidence || '0') || 0;
      let ok = true;
      if (diag && label !== diag) ok = false;
      if (conf < minc) ok = false;
      if (datef && date !== datef) ok = false;
      if (q && !(date+label).includes(q)) ok = false;
      card.style.display = ok ? '' : 'none';
    });
  }
  [fDiag, fMin, fDate, fSearch].forEach(el => el?.addEventListener('input', applyFilters));
  fReset?.addEventListener('click', () => { fDiag.value=''; fMin.value=0; fDate.value=''; fSearch.value=''; applyFilters(); });

  // Tri
  const heads = table.querySelectorAll('th[data-sort]');
  heads.forEach(th => th.addEventListener('click', () => {
    const key = th.dataset.sort;
    const tbody = table.querySelector('tbody');
    const sorted = rows.slice().sort((a,b) => {
      const ta = a.querySelectorAll('td');
      const tb = b.querySelectorAll('td');
      if (key==='date') return (ta[0].textContent>tb[0].textContent)?1:-1;
      if (key==='label') return (ta[1].textContent>tb[1].textContent)?1:-1;
      if (key==='confidence') return (parseFloat(ta[2].textContent) - parseFloat(tb[2].textContent));
      return 0;
    });
    tbody.innerHTML = '';
    sorted.forEach(tr => tbody.appendChild(tr));
  }));

  // View toggle + progress widths
  const viewTableBtn = document.getElementById('viewTable');
  const viewCardsBtn = document.getElementById('viewCards');
  function syncProgress(){
    cardsWrap.querySelectorAll('.analysis-card .progress > span').forEach(el => {
      const w = parseFloat(el.getAttribute('data-width') || '0');
      el.style.width = (isFinite(w) ? w : 0) + '%';
    });
  }
  viewTableBtn?.addEventListener('click', () => {
    document.getElementById('analysesTable').style.display = '';
    cardsWrap.style.display = 'none';
  });
  viewCardsBtn?.addEventListener('click', () => {
    document.getElementById('analysesTable').style.display = 'none';
    cardsWrap.style.display = '';
    syncProgress();
  });
  // Initialize progress when landing directly on cards (if ever toggled)
  syncProgress();

  // Modal
  const modal = document.getElementById('analysisModal');
  const mClose = document.getElementById('modalClose');
  function openModal(d){
    document.getElementById('mImage').src = d.img || '';
    document.getElementById('mDate').textContent = d.date || '—';
    document.getElementById('mLabel').textContent = d.label || '—';
    document.getElementById('mConf').textContent = (d.confidence? d.confidence+'%':'—');
    document.getElementById('mDesc').textContent = d.desc || '—';
    modal.classList.add('open');
  }
  function closeModal(){ modal.classList.remove('open'); }
  mClose?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
  document.querySelectorAll('.open-modal').forEach(btn => {
    btn.addEventListener('click', () => openModal({
      id: btn.dataset.id,
      date: btn.dataset.date,
      label: btn.dataset.label,
      confidence: btn.dataset.confidence,
      img: btn.dataset.img,
      desc: btn.dataset.desc
    }));
  });

  // Expand/Collapse right column to be wider
  const expandBtn = document.getElementById('toggleExpand');
  const grid = document.querySelector('.pro-grid');
  expandBtn?.addEventListener('click', () => {
    const expanded = grid.classList.toggle('expanded');
    expandBtn.innerHTML = expanded
      ? '<i class="fas fa-minimize"></i> Réduire'
      : '<i class="fas fa-arrows-left-right-to-line"></i> Étendre';
  });
</script>
{% endblock %}
