<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alertes Médicales | NeuroScan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% extends "base_dashboard.html" %}

    {% block title %}Alertes Médicales - NeuroScan{% endblock %}
    {% block page_subtitle %}Surveillance & Sécurité{% endblock %}
    {% block page_title %}Alertes Médicales{% endblock %}
    {% block page_description %}Surveillez, priorisez et résolvez les alertes générées automatiquement par l’IA{% endblock %}

    {% block extra_css %}
    <style>
            /* Accents et composants spécifiques à la page */
            .alert-card { position: relative; }
            .alert-card::before { content: ''; position: absolute; inset: 0 0 0 0; pointer-events: none; border-radius: var(--radius-xl); }
            .alert-high::before { border-left: 4px solid rgba(239,68,68,.8); }
            .alert-medium::before { border-left: 4px solid rgba(245,158,11,.8); }
            .alert-low::before { border-left: 4px solid rgba(59,130,246,.8); }
            .alert-unread { background: linear-gradient(180deg, rgba(59,130,246,.05), rgba(59,130,246,.02)); }

            .severity-badge { font-size: .75rem; font-weight: 700; padding: .35rem .7rem; border-radius: 9999px; color: #fff; }
            .badge-danger { background: #ef4444; }
            .badge-warning { background: #f59e0b; }
            .badge-info { background: #3b82f6; }

            .meta-chip { display: inline-flex; align-items: center; gap: .5rem; padding: .35rem .7rem; border-radius: 9999px; background: #f3f4f6; color: #374151; font-size: .8rem; font-weight: 600; border: 1px solid #e5e7eb; }
            .status-chip { display: inline-flex; align-items: center; gap: .4rem; padding: .3rem .6rem; border-radius: 9999px; font-size: .75rem; font-weight: 700; border: 1px solid transparent; }
            .status-unread { background: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
            .status-read { background: #f3f4f6; color: #374151; border-color: #e5e7eb; }

            .lamp-dot { width: 10px; height: 10px; border-radius: 9999px; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset; margin-right: .5rem; }
            .lamp-danger { background: #ef4444; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset, 0 0 8px rgba(239,68,68,.7); }
            .lamp-warning { background: #f59e0b; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset, 0 0 8px rgba(245,158,11,.6); }
            .lamp-info { background: #3b82f6; box-shadow: 0 0 0 2px rgba(255,255,255,.9) inset, 0 0 8px rgba(59,130,246,.5); }

            /* Conteneur filtres */
            .alerts-filters { background: var(--surface-primary); border: 1px solid rgba(229,231,235,.6); border-radius: var(--radius-xl); padding: 16px; }
    </style>
    {% endblock %}

    {% block secondary_nav %}
    <div class="dashboard-nav mb-8">
            <a href="{{ url_for('dashboard') }}" class="dashboard-nav-item">
                    <i class="fas fa-home mr-2"></i>Accueil
            </a>
            <a href="{{ url_for('patients_list') }}" class="dashboard-nav-item">
                    <i class="fas fa-users mr-2"></i>Mes Patients
            </a>
            <a href="{{ url_for('medical_alerts_page') }}" class="dashboard-nav-item active">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Alertes
            </a>
    </div>
    {% endblock %}

    {% block page_actions %}
    <div class="flex space-x-3">
            <button onclick="alertsPage_markAllAsRead()" class="btn-dashboard secondary">
                    <i class="fas fa-check-double"></i> Tout marquer comme lu
            </button>
            <button onclick="alertsPage_export()" class="btn-dashboard success">
                    <i class="fas fa-download"></i> Exporter
            </button>
            <button onclick="alertsPage_refresh()" class="btn-dashboard primary">
                    <i class="fas fa-sync-alt"></i> Actualiser
            </button>
            </div>
    {% endblock %}

    {% block content %}
    <!-- Statistiques rapides -->
    <div class="stats-grid mb-8">
            <div class="stat-card">
                    <div class="flex items-center justify-between">
                            <div>
                                    <p class="stat-label">Critiques</p>
                                    <p class="stat-value text-red-600" id="criticalCount">-</p>
                            </div>
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                            </div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="flex items-center justify-between">
                            <div>
                                    <p class="stat-label">Moyennes</p>
                                    <p class="stat-value text-amber-600" id="mediumCount">-</p>
                            </div>
                            <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-circle text-amber-600 text-xl"></i>
                            </div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="flex items-center justify-between">
                            <div>
                                    <p class="stat-label">Faibles</p>
                                    <p class="stat-value text-blue-600" id="lowCount">-</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-info-circle text-blue-600 text-xl"></i>
                            </div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="flex items-center justify-between">
                            <div>
                                    <p class="stat-label">Non lues</p>
                                    <p class="stat-value text-gray-700" id="unreadCount">-</p>
                            </div>
                            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-envelope-open text-gray-600 text-xl"></i>
                            </div>
                    </div>
            </div>
    </div>

    <!-- Filtres -->
    <div class="alerts-filters mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                            <label class="form-label"><i class="fas fa-exclamation-triangle mr-2"></i>Sévérité</label>
                            <select id="severityFilter" class="form-select">
                                    <option value="">Toutes les sévérités</option>
                                    <option value="high">Critiques</option>
                                    <option value="medium">Moyennes</option>
                                    <option value="low">Faibles</option>
                            </select>
                    </div>
                    <div>
                            <label class="form-label"><i class="fas fa-tags mr-2"></i>Type</label>
                            <select id="typeFilter" class="form-select">
                                    <option value="">Tous les types</option>
                                    <option value="new_tumor_detected">Nouvelle tumeur</option>
                                    <option value="diagnosis_change">Changement diagnostic</option>
                                    <option value="rapid_growth">Croissance rapide</option>
                                    <option value="confidence_drop">Baisse confiance</option>
                            </select>
                    </div>
                    <div>
                            <label class="form-label"><i class="fas fa-eye mr-2"></i>Statut</label>
                            <select id="statusFilter" class="form-select">
                                    <option value="">Tous les statuts</option>
                                    <option value="unread">Non lues</option>
                                    <option value="read">Lues</option>
                            </select>
                    </div>
                    <div>
                            <label class="form-label"><i class="fas fa-search mr-2"></i>Recherche</label>
                            <input id="searchInput" type="text" class="form-input" placeholder="Rechercher (titre, message, patient)">
                    </div>
            </div>
    </div>

    <!-- Liste des alertes -->
    <div class="dashboard-card p-0" style="height: calc(100vh - 280px); display: flex; flex-direction: column;">
            <div class="flex items-center justify-between p-6 pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-bell text-neuroscan-600 mr-2"></i>
                            Alertes Actives
                            <span id="totalAlertsCount" class="ml-2 badge info">0</span>
                    </h3>
                    <div class="flex items-center space-x-2">
                            <button class="btn-dashboard secondary" onclick="alertsPage_refresh()"><i class="fas fa-sync-alt"></i></button>
                            <button class="btn-dashboard success" onclick="alertsPage_export()"><i class="fas fa-download"></i></button>
                    </div>
            </div>

            <div id="alertsPageList" class="space-y-4 px-6 pb-4 overflow-y-auto" style="flex:1 1 auto; min-height: 0; overscroll-behavior: contain; -webkit-overflow-scrolling: touch;">
                    <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Chargement des alertes...</p>
                    </div>
            </div>

            <div class="flex items-center justify-center p-4 border-t" id="paginationContainer" style="flex: 0 0 auto"></div>
    </div>

    <!-- Modal Détails Alerte -->
    <div id="alertDetailsModal" class="modal-overlay hidden">
        <div class="modal-content" style="--modal-width: 720px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-bell text-neuroscan-600"></i> Détails de l'alerte</h2>
                <button onclick="alertsPage_closeDetails()" class="modal-close"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="modal-body">
                <div id="alertDetailsBody" class="space-y-4"></div>
            </div>
            <div class="modal-footer">
                <div class="flex space-x-2">
                    <button id="alertDetailsResolveBtn" class="btn-dashboard success"><i class="fas fa-check"></i> Résoudre</button>
                    <button id="alertDetailsViewBtn" class="btn-dashboard primary"><i class="fas fa-user"></i> Voir le patient</button>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block extra_js %}
    <script>
    (() => {
        let ALERTS = [];
        let FILTERED = [];
        let PAGE = 1;
        const PAGE_SIZE = 10;
        let CURRENT = null;

        document.addEventListener('DOMContentLoaded', () => {
            setup();
            alertsPage_loadAlerts();
        });

        function setup() {
            document.getElementById('severityFilter').addEventListener('change', alertsPage_applyFilters);
            document.getElementById('typeFilter').addEventListener('change', alertsPage_applyFilters);
            document.getElementById('statusFilter').addEventListener('change', alertsPage_applyFilters);
            document.getElementById('searchInput').addEventListener('input', debounce(alertsPage_applyFilters, 250));
            document.getElementById('alertDetailsResolveBtn').addEventListener('click', () => { if (CURRENT) alertsPage_resolve(CURRENT.id); });
            document.getElementById('alertDetailsViewBtn').addEventListener('click', () => { if (CURRENT) window.location.href = `/patient/${CURRENT.patient_id}`; });

            // Empêcher la molette de faire défiler la page quand on est sur la liste
            const scroller = document.getElementById('alertsPageList');
            if (scroller) trapScroll(scroller);
        }

        async function alertsPage_loadAlerts() {
            try {
                const res = await fetch('/api/alerts');
                const json = await res.json();
                if (json && json.success) {
                    ALERTS = json.data;
                    FILTERED = [...ALERTS];
                    alertsPage_display();
                    alertsPage_updateStats();
                }
            } catch (e) { console.error('Erreur chargement alertes:', e); }
        }

        function alertsPage_updateStats() {
            const c = ALERTS.filter(a => a.severity === 'high').length;
            const m = ALERTS.filter(a => a.severity === 'medium').length;
            const l = ALERTS.filter(a => a.severity === 'low').length;
            const u = ALERTS.filter(a => !a.is_read).length;
            setText('criticalCount', c);
            setText('mediumCount', m);
            setText('lowCount', l);
            setText('unreadCount', u);
            setText('totalAlertsCount', FILTERED.length);
        }

            function alertsPage_display() {
                const list = document.getElementById('alertsPageList');
            const start = (PAGE - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const slice = FILTERED.slice(start, end);

            if (slice.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                        <h3 class="text-lg font-semibold mb-1">Aucune alerte trouvée</h3>
                        <p>Essayez d'élargir vos filtres.</p>
                        <button class="btn-dashboard secondary mt-4" onclick="alertsPage_clearFilters()"><i class=\"fas fa-times\"></i> Effacer les filtres</button>
                    </div>`;
                renderPagination(0);
                return;
            }

            list.innerHTML = slice.map(a => alertCardHTML(a)).join('');
            renderPagination(Math.ceil(FILTERED.length / PAGE_SIZE));
        }

        function alertCardHTML(alert) {
            const sevColor = getSeverityColor(alert.severity);
            const sevText = getSeverityText(alert.severity);
            const sevBadge = getSeverityBadgeClass(alert.severity);
            const lamp = getSeverityLampClass(alert.severity);
            return `
                <div class="patient-card alert-card p-5 ${alert.is_read ? '' : 'alert-unread'} alert-${alert.severity}" onclick="alertsPage_showDetails(${alert.id})">
                    <div class="flex items-start gap-4">
                        <div class="flex items-center">
                            <span class="lamp-dot ${lamp}"></span>
                            <i class="fas fa-${getSeverityIcon(alert.severity)} text-${sevColor} text-lg"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-3">
                                <h4 class="font-semibold text-gray-900">${escapeHTML(alert.title)}</h4>
                                <div class="flex items-center gap-2">
                                    <span class="severity-badge badge-${sevBadge}">${sevText}</span>
                                    <span class="status-chip ${alert.is_read ? 'status-read' : 'status-unread'}"><i class="fas fa-${alert.is_read ? 'envelope-open' : 'envelope'}"></i> ${alert.is_read ? 'Lue' : 'Non lue'}</span>
                                </div>
                            </div>
                            <p class="text-gray-600 mt-2">${escapeHTML(alert.message)}</p>
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex flex-wrap items-center gap-2">
                                    <span class="meta-chip"><i class="fas fa-tag"></i> ${getAlertTypeText(alert.alert_type)}</span>
                                    <span class="meta-chip"><i class="fas fa-user"></i> ${escapeHTML(alert.patient_name || '')}</span>
                                    <span class="meta-chip"><i class="fas fa-hashtag"></i> ${escapeHTML(String(alert.patient_id || ''))}</span>
                                    <span class="meta-chip"><i class="fas fa-clock"></i> ${alertsPage_formatDate(alert.created_at)}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${!alert.is_read ? `<button class=\"btn-dashboard secondary\" onclick=\"event.stopPropagation(); alertsPage_markRead(${alert.id})\"><i class=\"fas fa-check-double\"></i></button>` : ''}
                                    <button class="btn-dashboard success" onclick="event.stopPropagation(); alertsPage_resolve(${alert.id})"><i class="fas fa-check"></i></button>
                                    <button class="btn-dashboard primary" onclick="event.stopPropagation(); alertsPage_showDetails(${alert.id})"><i class="fas fa-eye"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function alertsPage_applyFilters() {
            const sev = document.getElementById('severityFilter').value;
            const type = document.getElementById('typeFilter').value;
            const status = document.getElementById('statusFilter').value;
            const q = (document.getElementById('searchInput').value || '').toLowerCase();

            FILTERED = ALERTS.filter(a => {
                const mSev = !sev || a.severity === sev;
                const mType = !type || a.alert_type === type;
                const mStatus = !status || (status === 'unread' ? !a.is_read : a.is_read);
                const mQ = !q ||
                    (a.title && a.title.toLowerCase().includes(q)) ||
                    (a.message && a.message.toLowerCase().includes(q)) ||
                    (a.patient_name && a.patient_name.toLowerCase().includes(q));
                return mSev && mType && mStatus && mQ;
            });

            PAGE = 1;
            alertsPage_display();
            alertsPage_updateStats();
        }

        function renderPagination(totalPages) {
            const el = document.getElementById('paginationContainer');
            if (totalPages <= 1) { el.innerHTML = ''; return; }
            let html = '';
            html += `<button class="btn-dashboard secondary text-xs" ${PAGE===1?'disabled':''} onclick="alertsPage_changePage(${PAGE-1})"><i class=\"fas fa-chevron-left\"></i></button>`;
            for (let i=1;i<=totalPages;i++) {
                if (i===PAGE) html += `<button class="btn-dashboard primary text-xs">${i}</button>`;
                else if (i===1 || i===totalPages || Math.abs(i-PAGE)<=1) html += `<button class="btn-dashboard secondary text-xs" onclick="alertsPage_changePage(${i})">${i}</button>`;
                else if (i===PAGE-2 || i===PAGE+2) html += `<span class="text-gray-400 px-2">...</span>`;
            }
            html += `<button class="btn-dashboard secondary text-xs" ${PAGE===totalPages?'disabled':''} onclick="alertsPage_changePage(${PAGE+1})"><i class=\"fas fa-chevron-right\"></i></button>`;
            el.innerHTML = html;
        }

        function alertsPage_changePage(p) {
            const total = Math.ceil(FILTERED.length / PAGE_SIZE);
            if (p>=1 && p<=total) { PAGE = p; alertsPage_display(); renderPagination(total); }
        }

        async function alertsPage_markRead(id) {
            try {
                const res = await fetch(`/api/alerts/${id}/mark-read`, { method:'POST', headers:{'Content-Type':'application/json'} });
                if (res.ok) {
                    const a = ALERTS.find(x=>x.id===id); if (a) a.is_read = true;
                    const b = FILTERED.find(x=>x.id===id); if (b) b.is_read = true;
                    alertsPage_display(); alertsPage_updateStats();
                }
            } catch(e){ console.error(e); }
        }

        async function alertsPage_resolve(id) {
            try {
                const res = await fetch(`/api/alerts/${id}/resolve`, { method:'POST', headers:{'Content-Type':'application/json'} });
                if (res.ok) {
                    ALERTS = ALERTS.filter(x=>x.id!==id);
                    FILTERED = FILTERED.filter(x=>x.id!==id);
                    alertsPage_display(); alertsPage_updateStats(); alertsPage_closeDetails();
                    showNotification('Alerte résolue avec succès', 'success');
                }
            } catch(e){ console.error(e); showNotification('Erreur lors de la résolution', 'error'); }
        }

        function alertsPage_markAllAsRead() {
            const unread = ALERTS.filter(a => !a.is_read);
            Promise.all(unread.map(a => alertsPage_markRead(a.id))).then(() => showNotification('Toutes les alertes ont été marquées comme lues', 'success'));
        }

        function alertsPage_refresh() { alertsPage_loadAlerts(); }

        function alertsPage_export() {
            const rows = FILTERED.map(a => [a.id, a.title, a.message, a.severity, a.patient_name, a.created_at, a.is_read ? 'Lu':'Non lu']);
            const csv = ['ID,Titre,Message,Sévérité,Patient,Date,Statut', ...rows.map(r => r.map(v => `"${String(v??'').replace(/"/g,'""')}"`).join(','))].join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `alertes_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showNotification('Export terminé', 'success');
        }

        function alertsPage_clearFilters() {
            document.getElementById('severityFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchInput').value = '';
            alertsPage_applyFilters();
        }

        function alertsPage_showDetails(id) {
            const a = ALERTS.find(x=>x.id===id); if (!a) return; CURRENT = a;
            const body = document.getElementById('alertDetailsBody');
            body.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="dashboard-card p-4">
                        <h3 class="font-semibold text-gray-900 mb-3">Informations</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600">Type</span><span class="font-medium">${getAlertTypeText(a.alert_type)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Sévérité</span><span class="severity-badge badge-${getSeverityColor(a.severity)}">${getSeverityText(a.severity)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Date</span><span class="font-medium">${alertsPage_formatDate(a.created_at)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Statut</span><span class="status-chip ${a.is_read?'status-read':'status-unread'}">${a.is_read?'Lue':'Non lue'}</span></div>
                        </div>
                    </div>
                    <div class="dashboard-card p-4">
                        <h3 class="font-semibold text-gray-900 mb-3">Patient</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600">Nom</span><span class="font-medium">${escapeHTML(a.patient_name || '')}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">ID</span><span class="font-medium">${escapeHTML(String(a.patient_id || ''))}</span></div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">Message</h3>
                    <p class="text-gray-700">${escapeHTML(a.message || '')}</p>
                </div>`;

            document.getElementById('alertDetailsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (!a.is_read) alertsPage_markRead(a.id);
        }

        function alertsPage_closeDetails() {
            document.getElementById('alertDetailsModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Utils
        function getSeverityIcon(sev) { return sev==='high'?'exclamation-triangle': sev==='medium'?'exclamation-circle':'info-circle'; }
        function getSeverityText(sev) { return sev==='high'?'Critique': sev==='medium'?'Moyenne': sev==='low'?'Faible':'Inconnue'; }
            function getSeverityColor(sev) { return sev==='high'?'red-500': sev==='medium'?'amber-500': sev==='low'?'blue-500':'gray-500'; }
            function getSeverityBadgeClass(sev) { return sev==='high'?'danger': sev==='medium'?'warning':'info'; }
        function getSeverityLampClass(sev) { return sev==='high'?'lamp-danger': sev==='medium'?'lamp-warning':'lamp-info'; }
        function getAlertTypeText(t) {
            switch(t){
                case 'new_tumor_detected': return 'Nouvelle tumeur détectée';
                case 'diagnosis_change': return 'Changement de diagnostic';
                case 'rapid_growth': return 'Croissance rapide';
                case 'confidence_drop': return 'Baisse de confiance';
                case 'tumor_resolved': return 'Amélioration significative';
                case 'high_grade_tumor': return 'Tumeur de haut grade';
                default: return t || '-';
            }
        }
        function alertsPage_formatDate(s){ const d=new Date(s); if(isNaN(d)) return '-'; const n=new Date(); const ms=n-d; const m=Math.floor(ms/60000), h=Math.floor(m/60), day=Math.floor(h/24); if(m<1) return "À l'instant"; if(m<60) return `Il y a ${m} min`; if(h<24) return `Il y a ${h}h`; if(day<7) return `Il y a ${day}j`; try { return d.toLocaleDateString('fr-FR'); } catch { return '-'; } }
        function setText(id, v){ const el=document.getElementById(id); if (el) el.textContent = v; }
        function escapeHTML(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
        function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); } }

        // Expose pour onclick
        window.alertsPage_markAllAsRead = alertsPage_markAllAsRead;
        window.alertsPage_export = alertsPage_export;
        window.alertsPage_refresh = alertsPage_refresh;
        window.alertsPage_clearFilters = alertsPage_clearFilters;
        window.alertsPage_changePage = alertsPage_changePage;
        window.alertsPage_showDetails = alertsPage_showDetails;
        window.alertsPage_markRead = alertsPage_markRead;
        window.alertsPage_resolve = alertsPage_resolve;
        window.alertsPage_closeDetails = alertsPage_closeDetails;

        // Scroll trap util to keep wheel/touch/keys within a container
        function trapScroll(el){
            // Wheel
            el.addEventListener('wheel', (e)=>{
                const delta = e.deltaY;
                const atTop = el.scrollTop === 0;
                const atBottom = Math.ceil(el.scrollTop + el.clientHeight) >= el.scrollHeight;
                if ((delta < 0 && atTop) || (delta > 0 && atBottom)) {
                    e.preventDefault();
                }
                e.stopPropagation();
            }, { passive: false });

            // Keys
            el.addEventListener('keydown', (e)=>{
                const keys = ['ArrowUp','ArrowDown','PageUp','PageDown','Home','End','Space'];
                if (!keys.includes(e.key)) return;
                const atTop = el.scrollTop === 0;
                const atBottom = Math.ceil(el.scrollTop + el.clientHeight) >= el.scrollHeight;
                if ((e.key==='ArrowUp'||e.key==='PageUp'||e.key==='Home') && atTop) {
                    e.preventDefault(); e.stopPropagation();
                } else if ((e.key==='ArrowDown'||e.key==='PageDown'||e.key==='End'||e.key==='Space') && atBottom) {
                    e.preventDefault(); e.stopPropagation();
                }
            });

            // Touch
            let startY = 0;
            el.addEventListener('touchstart', (e)=>{ startY = e.touches[0].clientY; }, { passive: true });
            el.addEventListener('touchmove', (e)=>{
                const y = e.touches[0].clientY;
                const delta = startY - y;
                const atTop = el.scrollTop === 0;
                const atBottom = Math.ceil(el.scrollTop + el.clientHeight) >= el.scrollHeight;
                if ((delta < 0 && atTop) || (delta > 0 && atBottom)) {
                    e.preventDefault();
                }
                e.stopPropagation();
            }, { passive: false });
        }
    })();
    </script>
    {% endblock %}
                <div class="toast show" role="alert" style="
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
                ">
                    <div class="toast-header" style="background: transparent; border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-${iconMap[type]} me-2"></i>
                        <strong class="me-auto">NeuroScan</strong>
                        <button type="button" class="btn-close" onclick="this.closest('.toast').parentElement.remove()"></button>
                    </div>
                    <div class="toast-body" style="font-weight: 500;">
                        ${message}
                    </div>
                </div>
            `;

            document.body.appendChild(toastContainer);

            setTimeout(() => {
                if (toastContainer.parentNode) {
                    toastContainer.style.animation = 'slideOutRight 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    setTimeout(() => toastContainer.remove(), 400);
                }
            }, 4000);
        }

        // Ajouter les animations CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.7; transform: scale(1.1); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
