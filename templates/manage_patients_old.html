<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Patients | NeuroScan</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --info-color: #0891b2;
            --light-bg: #f8fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }

        /* Header moderne avec gradient sophistiqué */
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header-section .container {
            position: relative;
            z-index: 1;
        }

        .header-section h1 {
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-section p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Navigation améliorée */
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--card-shadow);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color) !important;
        }

        .navbar-nav .nav-link {
            color: var(--secondary-color) !important;
            font-weight: 500;
            transition: var(--transition);
        }

        .navbar-nav .nav-link:hover {
            color: var(--primary-color) !important;
        }

        /* Cards modernes */
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            background: white;
        }

        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid #e2e8f0;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            padding: 1.25rem 1.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Statistiques avec design moderne */
        .stats-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-shadow-hover);
        }

        .stats-card.primary { border-left-color: var(--primary-color); }
        .stats-card.success { border-left-color: var(--success-color); }
        .stats-card.info { border-left-color: var(--info-color); }
        .stats-card.warning { border-left-color: var(--warning-color); }

        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .stats-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stats-card h5 {
            color: var(--secondary-color);
            font-weight: 500;
            margin: 0;
        }

        /* Boutons modernes */
        .btn {
            border-radius: var(--border-radius-sm);
            font-weight: 500;
            padding: 0.625rem 1.25rem;
            transition: var(--transition);
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(37, 99, 235, 0.4);
        }

        .btn-lg {
            padding: 0.875rem 2rem;
            font-size: 1.1rem;
            border-radius: var(--border-radius);
        }

        /* Formulaires améliorés */
        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 1rem;
            transition: var(--transition);
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .input-group-text {
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-right: none;
            color: var(--secondary-color);
        }

        .form-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .form-section h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.25rem;
            font-size: 1.1rem;
        }

        .required-field {
            color: var(--danger-color);
        }

        /* Table moderne */
        .table {
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .table thead th {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background-color: #f8fafc;
            transform: scale(1.01);
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #e2e8f0;
        }

        /* Badges modernes */
        .badge {
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* Boutons d'action */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .action-buttons .btn {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .btn-outline-info:hover { background-color: var(--info-color); color: white; }
        .btn-outline-primary:hover { background-color: var(--primary-color); color: white; }
        .btn-outline-success:hover { background-color: var(--success-color); color: white; }
        .btn-outline-danger:hover { background-color: var(--danger-color); color: white; }

        /* Modals améliorées */
        .modal-content {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid #e2e8f0;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Responsive amélioré */
        @media (max-width: 768px) {
            .header-section {
                padding: 2rem 0;
            }

            .header-section h1 {
                font-size: 2rem;
            }

            .stats-card {
                margin-bottom: 1rem;
            }

            .action-buttons {
                flex-wrap: wrap;
            }

            .table-responsive {
                border-radius: var(--border-radius);
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Toast amélioré */
        .toast {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow-hover);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-brain me-2"></i>NeuroScan
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text me-3">
                        <i class="fas fa-user-md me-1"></i>Dr. {{ doctor.full_name }}
                    </span>
                    <a class="nav-link" href="{{ url_for('dashboard') }}">
                        <i class="fas fa-arrow-left me-1"></i>Tableau de bord
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- En-tête -->
    <div class="header-section" style="margin-top: 76px;">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8 col-md-7">
                    <div class="fade-in-up">
                        <h1 class="mb-3">
                            <i class="fas fa-users-cog me-3"></i>Gestion des Patients
                        </h1>
                        <p class="mb-0">Gérez efficacement vos patients avec une interface moderne et intuitive</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-5 text-end mt-3 mt-md-0">
                    <button class="btn btn-light btn-lg shadow-lg" onclick="showAddPatientModal()">
                        <i class="fas fa-plus me-2"></i>Nouveau Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistiques rapides -->
        <div class="row mb-5">
            <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">
                <div class="stats-card primary fade-in-up">
                    <i class="fas fa-users text-primary"></i>
                    <h3 class="text-primary" id="totalPatients">-</h3>
                    <h5>Total Patients</h5>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">
                <div class="stats-card success fade-in-up" style="animation-delay: 0.1s;">
                    <i class="fas fa-user-plus text-success"></i>
                    <h3 class="text-success" id="newPatients">-</h3>
                    <h5>Nouveaux ce Mois</h5>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
                <div class="stats-card info fade-in-up" style="animation-delay: 0.2s;">
                    <i class="fas fa-chart-line text-info"></i>
                    <h3 class="text-info" id="patientsWithAnalyses">-</h3>
                    <h5>Avec Analyses</h5>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card warning fade-in-up" style="animation-delay: 0.3s;">
                    <i class="fas fa-clock text-warning"></i>
                    <h3 class="text-warning" id="lastUpdate">-</h3>
                    <h5>Dernière Mise à Jour</h5>
                </div>
            </div>
        </div>

        <!-- Filtres et recherche -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card fade-in-up" style="animation-delay: 0.4s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>Filtres et Recherche
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-lg-4 col-md-6">
                                <label class="form-label fw-semibold">Recherche</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Nom, ID, téléphone, email...">
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-6">
                                <label class="form-label fw-semibold">Genre</label>
                                <select class="form-select" id="genderFilter">
                                    <option value="">Tous les genres</option>
                                    <option value="M">Masculin</option>
                                    <option value="F">Féminin</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label fw-semibold">Trier par</label>
                                <select class="form-select" id="sortBy">
                                    <option value="patient_name">Nom</option>
                                    <option value="patient_id">ID Patient</option>
                                    <option value="created_at">Date de création</option>
                                    <option value="updated_at">Dernière modification</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="d-grid d-md-flex gap-2">
                                    <button class="btn btn-outline-primary" onclick="refreshPatients()">
                                        <i class="fas fa-sync-alt me-1"></i>Actualiser
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportPatients()">
                                        <i class="fas fa-download me-1"></i>Exporter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table des patients -->
        <div class="row">
            <div class="col-12">
                <div class="card fade-in-up" style="animation-delay: 0.5s;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Liste des Patients
                            </h5>
                        </div>
                        <div>
                            <span class="badge bg-primary fs-6 px-3 py-2" id="patientsCount">0</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="patientsTable">
                                <thead>
                                    <tr>
                                        <th class="ps-4">ID Patient</th>
                                        <th>Nom</th>
                                        <th>Genre</th>
                                        <th>Date de Naissance</th>
                                        <th>Téléphone</th>
                                        <th>Analyses</th>
                                        <th>Dernière Modification</th>
                                        <th class="text-center pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="patientsTableBody">
                                    <!-- Données chargées dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter/modifier un patient -->
    <div class="modal fade" id="patientModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="patientModalTitle">
                            <i class="fas fa-user-plus me-2"></i>Nouveau Patient
                        </h5>
                        <p class="text-muted mb-0 small">Remplissez les informations du patient</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="patientForm">
                        <!-- Informations de base -->
                        <div class="form-section">
                            <h6><i class="fas fa-user me-2"></i>Informations de Base</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="patient_id" class="form-label fw-semibold">
                                        ID Patient <span class="required-field">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="patient_id" name="patient_id" required>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>Identifiant unique du patient
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="patient_name" class="form-label fw-semibold">
                                        Nom Complet <span class="required-field">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="patient_name" name="patient_name" required>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-4">
                                    <label for="date_of_birth" class="form-label fw-semibold">Date de Naissance</label>
                                    <input type="date" class="form-control" id="date_of_birth" name="date_of_birth">
                                </div>
                                <div class="col-md-4">
                                    <label for="gender" class="form-label fw-semibold">Genre</label>
                                    <select class="form-select" id="gender" name="gender">
                                        <option value="">Sélectionner...</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="insurance_number" class="form-label fw-semibold">Numéro d'Assurance</label>
                                    <input type="text" class="form-control" id="insurance_number" name="insurance_number">
                                </div>
                            </div>
                        </div>

                        <!-- Informations de contact -->
                        <div class="form-section">
                            <h6><i class="fas fa-address-book me-2"></i>Informations de Contact</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="phone" class="form-label fw-semibold">Téléphone</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input type="tel" class="form-control" id="phone" name="phone" placeholder="+33 1 23 45 67 89">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label fw-semibold">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input type="email" class="form-control" id="email" name="email" placeholder="patient@example.com">
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-12">
                                    <label for="address" class="form-label fw-semibold">Adresse</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                        <textarea class="form-control" id="address" name="address" rows="2" placeholder="Adresse complète du patient"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact d'urgence -->
                        <div class="form-section">
                            <h6><i class="fas fa-phone-alt me-2"></i>Contact d'Urgence</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="emergency_contact_name" class="form-label fw-semibold">Nom du Contact</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user-friends"></i></span>
                                        <input type="text" class="form-control" id="emergency_contact_name" name="emergency_contact_name" placeholder="Nom du contact d'urgence">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="emergency_contact_phone" class="form-label fw-semibold">Téléphone d'Urgence</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone-alt"></i></span>
                                        <input type="tel" class="form-control" id="emergency_contact_phone" name="emergency_contact_phone" placeholder="+33 1 23 45 67 89">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informations médicales -->
                        <div class="form-section">
                            <h6><i class="fas fa-stethoscope me-2"></i>Informations Médicales</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="medical_history" class="form-label fw-semibold">Antécédents Médicaux</label>
                                    <textarea class="form-control" id="medical_history" name="medical_history" rows="3" placeholder="Historique médical du patient..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="allergies" class="form-label fw-semibold">Allergies</label>
                                    <textarea class="form-control" id="allergies" name="allergies" rows="3" placeholder="Allergies connues..."></textarea>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="current_medications" class="form-label fw-semibold">Médicaments Actuels</label>
                                    <textarea class="form-control" id="current_medications" name="current_medications" rows="3" placeholder="Traitements en cours..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="notes" class="form-label fw-semibold">Notes Additionnelles</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Informations complémentaires..."></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <button type="button" class="btn btn-primary" onclick="savePatient()">
                        <i class="fas fa-save me-1"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmer la Suppression</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5>Attention !</h5>
                        <p>Êtes-vous sûr de vouloir supprimer ce patient ?</p>
                        <p class="text-muted">
                            <strong id="patientToDelete"></strong><br>
                            Cette action supprimera définitivement :
                        </p>
                        <ul class="text-start text-muted">
                            <li>Toutes les informations du patient</li>
                            <li>Toutes les analyses associées</li>
                            <li>Tout l'historique d'évolution</li>
                            <li>Toutes les alertes médicales</li>
                        </ul>
                        <p class="text-danger"><strong>Cette action est irréversible !</strong></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeletePatient()">
                        <i class="fas fa-trash me-1"></i>Supprimer Définitivement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de détails patient -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Détails du Patient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="patientDetailsContent">
                    <!-- Contenu chargé dynamiquement -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="editPatientFromDetails()">
                        <i class="fas fa-edit me-1"></i>Modifier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        let allPatients = [];
        let currentPatient = null;
        let patientToDeleteId = null;
        let isEditMode = false;

        document.addEventListener('DOMContentLoaded', function() {
            // Ajouter un loader initial
            showLoader();

            loadPatients();
            setupEventListeners();

            // Initialiser les animations
            initializeAnimations();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterPatients);
            document.getElementById('genderFilter').addEventListener('change', filterPatients);
            document.getElementById('sortBy').addEventListener('change', sortPatients);
        }



        function displayPatients() {
            const tbody = document.getElementById('patientsTableBody');

            if (allPatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="fade-in-up">
                                <i class="fas fa-users fa-4x text-muted mb-4"></i>
                                <h4 class="text-muted mb-3">Aucun patient trouvé</h4>
                                <p class="text-muted mb-4">Commencez par ajouter votre premier patient pour démarrer la gestion</p>
                                <button class="btn btn-primary btn-lg" onclick="showAddPatientModal()">
                                    <i class="fas fa-plus me-2"></i>Ajouter un Patient
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allPatients.map((patient, index) => `
                <tr class="fade-in-up" style="animation-delay: ${index * 0.05}s;">
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; font-size: 0.8rem; font-weight: bold;">
                                ${patient.patient_id.substring(0, 2).toUpperCase()}
                            </div>
                            <strong>${patient.patient_id}</strong>
                        </div>
                    </td>
                    <td>
                        <div>
                            <div class="fw-semibold">${patient.patient_name || 'Non renseigné'}</div>
                            ${patient.email ? `<small class="text-muted">${patient.email}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        ${patient.gender ?
                            `<span class="badge bg-${patient.gender === 'M' ? 'primary' : patient.gender === 'F' ? 'pink' : 'secondary'} rounded-pill">${getGenderText(patient.gender)}</span>` :
                            '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>
                        ${patient.date_of_birth ?
                            `<div>
                                <div>${formatDate(patient.date_of_birth)}</div>
                                <small class="text-muted">${calculateAge(patient.date_of_birth)} ans</small>
                            </div>` :
                            '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>
                        ${patient.phone ?
                            `<a href="tel:${patient.phone}" class="text-decoration-none">${patient.phone}</a>` :
                            '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>
                        <span class="badge ${patient.total_analyses > 0 ? 'bg-success' : 'bg-secondary'} rounded-pill">
                            ${patient.total_analyses || 0}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted">
                            ${patient.updated_at ? formatDateTime(patient.updated_at) : formatDateTime(patient.created_at)}
                        </small>
                    </td>
                    <td class="text-center pe-4">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-info" onclick="showPatientDetails('${patient.patient_id}')" title="Voir détails" data-bs-toggle="tooltip">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="editPatient('${patient.patient_id}')" title="Modifier" data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="viewPatientProfile('${patient.patient_id}')" title="Profil complet" data-bs-toggle="tooltip">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('${patient.patient_id}', '${patient.patient_name}')" title="Supprimer" data-bs-toggle="tooltip">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Initialiser les tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            document.getElementById('patientsCount').textContent = allPatients.length;
        }

        function updateStats() {
            document.getElementById('totalPatients').textContent = allPatients.length;

            // Nouveaux patients ce mois
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const newThisMonth = allPatients.filter(p =>
                new Date(p.created_at) >= thisMonth
            ).length;
            document.getElementById('newPatients').textContent = newThisMonth;

            // Patients avec analyses
            const withAnalyses = allPatients.filter(p => p.total_analyses > 0).length;
            document.getElementById('patientsWithAnalyses').textContent = withAnalyses;

            // Dernière mise à jour
            if (allPatients.length > 0) {
                const lastUpdate = allPatients.reduce((latest, patient) => {
                    const patientDate = new Date(patient.updated_at || patient.created_at);
                    return patientDate > latest ? patientDate : latest;
                }, new Date(0));

                document.getElementById('lastUpdate').textContent = formatRelativeTime(lastUpdate);
            }
        }

        function showAddPatientModal() {
            isEditMode = false;
            currentPatient = null;
            document.getElementById('patientModalTitle').textContent = 'Nouveau Patient';
            document.getElementById('patientForm').reset();
            document.getElementById('patient_id').disabled = false;

            // Supprimer le champ caché s'il existe
            const hiddenIdField = document.getElementById('hidden_patient_id');
            if (hiddenIdField) {
                hiddenIdField.remove();
            }

            new bootstrap.Modal(document.getElementById('patientModal')).show();
        }

        async function editPatient(patientId) {
            try {
                const response = await fetch(`/api/patients/${patientId}/details`);
                const data = await response.json();

                if (data.success) {
                    isEditMode = true;
                    currentPatient = data.data;
                    document.getElementById('patientModalTitle').textContent = 'Modifier Patient';

                    // Remplir le formulaire
                    Object.keys(data.data).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = data.data[key] || '';
                        }
                    });

                    document.getElementById('patient_id').disabled = true;
                    // Ajouter un champ caché pour l'ID patient en mode édition
                    let hiddenIdField = document.getElementById('hidden_patient_id');
                    if (!hiddenIdField) {
                        hiddenIdField = document.createElement('input');
                        hiddenIdField.type = 'hidden';
                        hiddenIdField.id = 'hidden_patient_id';
                        hiddenIdField.name = 'patient_id';
                        document.getElementById('patientForm').appendChild(hiddenIdField);
                    }
                    hiddenIdField.value = data.data.patient_id;

                    new bootstrap.Modal(document.getElementById('patientModal')).show();
                } else {
                    showToast('Erreur lors du chargement des détails: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des détails:', error);
                showToast('Erreur lors du chargement des détails', 'error');
            }
        }

        async function savePatient() {
            const form = document.getElementById('patientForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // En mode édition, ajouter l'ID du patient même s'il est désactivé
            if (isEditMode && currentPatient) {
                data.patient_id = currentPatient.patient_id;
            }

            // Validation détaillée
            const errors = [];
            if (!data.patient_id || data.patient_id.trim() === '') {
                errors.push('ID Patient');
            }
            if (!data.patient_name || data.patient_name.trim() === '') {
                errors.push('Nom du patient');
            }

            if (errors.length > 0) {
                showToast(`Veuillez remplir les champs obligatoires : ${errors.join(', ')}`, 'error');
                return;
            }

            // Debug temporaire - à supprimer après test
            console.log('Mode édition:', isEditMode);
            console.log('Patient actuel:', currentPatient);
            console.log('Données à envoyer:', data);

            try {
                const url = isEditMode ? `/api/patients/${currentPatient.patient_id}` : '/api/patients';
                const method = isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
                    loadPatients(); // Recharger la liste
                } else {
                    showToast('Erreur: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showToast('Erreur lors de la sauvegarde', 'error');
            }
        }

        function showDeleteModal(patientId, patientName) {
            patientToDeleteId = patientId;
            document.getElementById('patientToDelete').textContent = `${patientName} (${patientId})`;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        async function confirmDeletePatient() {
            if (!patientToDeleteId) return;

            try {
                const response = await fetch(`/api/patients/${patientToDeleteId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    loadPatients(); // Recharger la liste
                } else {
                    showToast('Erreur: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Fonctions utilitaires
        function getGenderText(gender) {
            switch(gender) {
                case 'M': return 'Masculin';
                case 'F': return 'Féminin';
                case 'Autre': return 'Autre';
                default: return '';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Aujourd\'hui';
            if (diffDays === 1) return 'Hier';
            if (diffDays < 7) return `Il y a ${diffDays} jours`;
            if (diffDays < 30) return `Il y a ${Math.floor(diffDays / 7)} semaines`;
            return `Il y a ${Math.floor(diffDays / 30)} mois`;
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            return age;
        }

        function showToast(message, type) {
            // Créer un conteneur de toast s'il n'existe pas
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast fade-in-up" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <div class="rounded me-2 ${type === 'success' ? 'bg-success' : 'bg-danger'}" style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'} text-white" style="font-size: 0.7rem;"></i>
                        </div>
                        <strong class="me-auto">NeuroScan</strong>
                        <small class="text-muted">maintenant</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 5000
            });

            toast.show();

            // Supprimer le toast après fermeture
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function viewPatientProfile(patientId) {
            window.location.href = `/patient/${patientId}`;
        }

        function filterPatients() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const genderFilter = document.getElementById('genderFilter').value;

            const filtered = allPatients.filter(patient => {
                const matchesSearch = patient.patient_name?.toLowerCase().includes(searchTerm) ||
                                    patient.patient_id.toLowerCase().includes(searchTerm) ||
                                    patient.phone?.toLowerCase().includes(searchTerm) ||
                                    patient.email?.toLowerCase().includes(searchTerm);

                const matchesGender = !genderFilter || patient.gender === genderFilter;

                return matchesSearch && matchesGender;
            });

            // Temporairement remplacer allPatients pour l'affichage
            const originalPatients = allPatients;
            allPatients = filtered;
            displayPatients();
            allPatients = originalPatients;
        }

        function sortPatients() {
            const sortBy = document.getElementById('sortBy').value;

            allPatients.sort((a, b) => {
                let aVal = a[sortBy] || '';
                let bVal = b[sortBy] || '';

                if (sortBy.includes('date') || sortBy.includes('at')) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                return aVal > bVal ? 1 : -1;
            });

            displayPatients();
        }

        function refreshPatients() {
            loadPatients();
            showToast('Liste des patients actualisée', 'success');
        }

        function exportPatients() {
            const csvContent = "data:text/csv;charset=utf-8," +
                "ID Patient,Nom,Genre,Date de Naissance,Téléphone,Email,Analyses,Créé le\n" +
                allPatients.map(p =>
                    `"${p.patient_id}","${p.patient_name || ''}","${getGenderText(p.gender) || ''}","${p.date_of_birth || ''}","${p.phone || ''}","${p.email || ''}","${p.total_analyses || 0}","${formatDateTime(p.created_at)}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `patients_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Export terminé', 'success');
        }

        async function showPatientDetails(patientId) {
            try {
                const response = await fetch(`/api/patients/${patientId}/details`);
                const data = await response.json();

                if (data.success) {
                    const patient = data.data;
                    currentPatient = patient;

                    document.getElementById('patientDetailsContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Informations de Base</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>ID Patient:</strong></td><td>${patient.patient_id}</td></tr>
                                    <tr><td><strong>Nom:</strong></td><td>${patient.patient_name || 'Non renseigné'}</td></tr>
                                    <tr><td><strong>Date de naissance:</strong></td><td>${patient.date_of_birth ? formatDate(patient.date_of_birth) : 'Non renseignée'}</td></tr>
                                    <tr><td><strong>Genre:</strong></td><td>${patient.gender ? getGenderText(patient.gender) : 'Non renseigné'}</td></tr>
                                    <tr><td><strong>Assurance:</strong></td><td>${patient.insurance_number || 'Non renseignée'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Contact</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Téléphone:</strong></td><td>${patient.phone || 'Non renseigné'}</td></tr>
                                    <tr><td><strong>Email:</strong></td><td>${patient.email || 'Non renseigné'}</td></tr>
                                    <tr><td><strong>Adresse:</strong></td><td>${patient.address || 'Non renseignée'}</td></tr>
                                </table>
                                <h6 class="text-primary mt-3">Contact d'Urgence</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Nom:</strong></td><td>${patient.emergency_contact_name || 'Non renseigné'}</td></tr>
                                    <tr><td><strong>Téléphone:</strong></td><td>${patient.emergency_contact_phone || 'Non renseigné'}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-primary">Informations Médicales</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Antécédents:</strong><br>
                                        <p class="text-muted">${patient.medical_history || 'Aucun antécédent renseigné'}</p>
                                        <strong>Allergies:</strong><br>
                                        <p class="text-muted">${patient.allergies || 'Aucune allergie renseignée'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Médicaments actuels:</strong><br>
                                        <p class="text-muted">${patient.current_medications || 'Aucun médicament renseigné'}</p>
                                        <strong>Notes:</strong><br>
                                        <p class="text-muted">${patient.notes || 'Aucune note'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-primary">Statistiques</h6>
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <h5 class="text-info">${patient.total_analyses || 0}</h5>
                                            <small>Analyses</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <h5 class="text-success">${patient.first_analysis_date ? formatDate(patient.first_analysis_date) : 'Aucune'}</h5>
                                            <small>Première analyse</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <h5 class="text-warning">${patient.last_analysis_date ? formatDate(patient.last_analysis_date) : 'Aucune'}</h5>
                                            <small>Dernière analyse</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <h5 class="text-secondary">${formatDateTime(patient.created_at)}</h5>
                                            <small>Créé le</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    new bootstrap.Modal(document.getElementById('detailsModal')).show();
                } else {
                    showToast('Erreur lors du chargement des détails: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des détails:', error);
                showToast('Erreur lors du chargement des détails', 'error');
            }
        }

        function editPatientFromDetails() {
            bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
            setTimeout(() => editPatient(currentPatient.patient_id), 300);
        }

        // Fonctions utilitaires pour l'UI
        function showLoader() {
            const loader = document.createElement('div');
            loader.id = 'page-loader';
            loader.innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <span class="ms-3">Chargement des patients...</span>
                </div>
            `;

            const tableBody = document.getElementById('patientsTableBody');
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="8">${loader.innerHTML}</td></tr>`;
            }
        }

        function hideLoader() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.remove();
            }
        }

        function initializeAnimations() {
            // Observer pour les animations au scroll
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in-up');
                    }
                });
            }, {
                threshold: 0.1
            });

            // Observer tous les éléments avec la classe d'animation
            document.querySelectorAll('.stats-card, .card').forEach(el => {
                observer.observe(el);
            });
        }

        // Améliorer la fonction de chargement des patients
        async function loadPatients() {
            try {
                showLoader();
                const response = await fetch('/api/my-patients');
                const data = await response.json();

                if (data.success) {
                    allPatients = data.data;
                    displayPatients();
                    updateStats();
                    hideLoader();
                } else {
                    hideLoader();
                    showToast('Erreur lors du chargement des patients: ' + data.error, 'error');
                }
            } catch (error) {
                hideLoader();
                console.error('Erreur lors du chargement des patients:', error);
                showToast('Erreur lors du chargement des patients', 'error');
            }
        }

        // Ajouter des effets de survol pour les cartes de statistiques
        document.addEventListener('DOMContentLoaded', function() {
            const statsCards = document.querySelectorAll('.stats-card');
            statsCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
    </script>
</body>
</html>
